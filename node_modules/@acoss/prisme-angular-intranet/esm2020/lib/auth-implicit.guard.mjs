import { Inject, Injectable } from '@angular/core';
import { PrismeAngularConfiguration, PRISME_FAILURE_LOGIN_HANDLER, PRISME_SUCCESS_LOGIN_HANDLER } from './prisme-angular.config';
import * as i0 from "@angular/core";
import * as i1 from "./service/oauth.service";
import * as i2 from "./service/login.service";
import * as i3 from "./service/oauth-callback.service";
import * as i4 from "./service/refresh.service";
import * as i5 from "./prisme-angular.config";
export class AuthImplicitGuard {
    constructor(successLH, failureLH, environment, oauthService, loginService, oauthCallBackService, refreshService, _ngZone) {
        this.environment = environment;
        this.oauthService = oauthService;
        this.loginService = loginService;
        this.oauthCallBackService = oauthCallBackService;
        this.refreshService = refreshService;
        this._ngZone = _ngZone;
        this.successLH = successLH;
        this.failureLH = failureLH;
    }
    // Methode "GUARD" devant être résolue pour avant l'accès à une page protégée
    canActivate(route, state) {
        // En cas d'erreur, il y a des queryParams (notamment "?error=...")
        if (route.queryParams && route.queryParams['error']) {
            const error = route.queryParams['error'];
            switch (error) {
                case 'reset_password_required': {
                    // Cela signifie que l'utilisateur a cliqué sur le lien "mot de passe oublié"
                    alert('Le mot de passe de cette application est votre mot de passe Anais');
                    break;
                }
                default: {
                    // Cela signifie qu'il y a eu une erreur
                    this.failureLH.failureLogin(this.loginService);
                    return false;
                }
            }
        }
        if (this.loginService.isConnecte()) {
            this.refreshService.relancerRafraichissement();
            return true;
        }
        // Authentification directe via WebMessage
        // (un fragment spécifique présent dans l'url permet d'activer ce mode d'ouverture)
        if (this.oauthService.isDelegatedOpeningWithWebMessage(route.fragment)) {
            const result = this.connexionViaWebMessageHTML5();
            this.sendReadyWebMessageHTML5();
            return result;
        }
        // Authentification avec un fragment présent dans l'url
        if (route.fragment) {
            return this.connexionViaURLFragment(route.fragment);
        }
        // Redirection vers la mire d'authentification
        window.location.href = this.oauthService.authentificationFrontUrl(state.url);
        return false;
    }
    // Mode de connexion Cross-Domain via passage de Jeton avec usage du WebMessaging HTML5
    connexionViaWebMessageHTML5() {
        const myOauthCallBackService = this.oauthCallBackService;
        const mySuccessLH = this.successLH;
        const myFailureLH = this.failureLH;
        const myRefreshService = this.refreshService;
        const myLoginService = this.loginService;
        const myEnvironment = this.environment;
        return new Promise(function (resolve, reject) {
            // Ajout d'un listener en attente des evenements de type 'message'
            window.addEventListener('message', (e) => {
                if (e.data.topic === myEnvironment.jetonMessageTopic) {
                    const tokenValue = e.data.token_value;
                    // A la reception d'un message de type token, lancement des traitements de login
                    if (e.data.token_type === 'jwt') {
                        myOauthCallBackService.handleAccessToken(tokenValue, 'portail', () => mySuccessLH.successLogin(myRefreshService), () => myFailureLH.failureLogin(myLoginService))
                            .then(() => {
                            myRefreshService.initierRafraichissement();
                            resolve(true);
                        });
                    }
                    else if (e.data.token_type === 'ocean') {
                        myOauthCallBackService.handleJetonOcean(tokenValue, () => mySuccessLH.successLogin(myRefreshService), () => myFailureLH.failureLogin(myLoginService))
                            .then(() => {
                            myRefreshService.initierRafraichissement();
                            resolve(true);
                        });
                    }
                }
            });
        });
    }
    // Mode de connexion Cross-Domain via passage de Jeton avec usage URLFragment
    // Usage limité à des jetons <2ko pour IE
    connexionViaURLFragment(routeFragment) {
        return new Promise((resolve) => {
            this.oauthCallBackService
                .handleFragment(routeFragment, () => this.successLH.successLogin(this.refreshService), () => this.failureLH.failureLogin(this.loginService))
                .then(() => {
                this.refreshService.initierRafraichissement();
                resolve(true);
            }).catch(function () { }); // prevents "Uncaught (in promise) error
        });
    }
    sendReadyWebMessageHTML5() {
        const message = new AuthImplicitGuard.ReadyWebMessage(this.environment.jetonReadyTopic, null);
        window.parent.postMessage(message, '*');
    }
}
AuthImplicitGuard.ReadyWebMessage = class {
    constructor(aTopic, aData) {
        this.topic = aTopic;
        this.data = aData;
    }
};
AuthImplicitGuard.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.1.0", ngImport: i0, type: AuthImplicitGuard, deps: [{ token: PRISME_SUCCESS_LOGIN_HANDLER }, { token: PRISME_FAILURE_LOGIN_HANDLER }, { token: PrismeAngularConfiguration }, { token: i1.OauthService }, { token: i2.LoginService }, { token: i3.OauthCallbackService }, { token: i4.RefreshService }, { token: i0.NgZone }], target: i0.ɵɵFactoryTarget.Injectable });
AuthImplicitGuard.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.1.0", ngImport: i0, type: AuthImplicitGuard, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.1.0", ngImport: i0, type: AuthImplicitGuard, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [PRISME_SUCCESS_LOGIN_HANDLER]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [PRISME_FAILURE_LOGIN_HANDLER]
                }] }, { type: i5.PrismeAngularConfiguration, decorators: [{
                    type: Inject,
                    args: [PrismeAngularConfiguration]
                }] }, { type: i1.OauthService }, { type: i2.LoginService }, { type: i3.OauthCallbackService }, { type: i4.RefreshService }, { type: i0.NgZone }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC1pbXBsaWNpdC5ndWFyZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2Fjb3NzL3ByaXNtZS1hbmd1bGFyLWludHJhbmV0L3NyYy9saWIvYXV0aC1pbXBsaWNpdC5ndWFyZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBVSxNQUFNLGVBQWUsQ0FBQztBQUkzRCxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsNEJBQTRCLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQzs7Ozs7OztBQVNqSSxNQUFNLE9BQU8saUJBQWlCO0lBYzVCLFlBQ3dDLFNBQXVDLEVBQ3ZDLFNBQXVDLEVBQ2pDLFdBQXVDLEVBQzNFLFlBQTBCLEVBQzFCLFlBQTBCLEVBQzFCLG9CQUEwQyxFQUMxQyxjQUE4QixFQUM5QixPQUFlO1FBTHFCLGdCQUFXLEdBQVgsV0FBVyxDQUE0QjtRQUMzRSxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQix5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBQzFDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5QixZQUFPLEdBQVAsT0FBTyxDQUFRO1FBRXZCLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBQzNCLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO0lBQzdCLENBQUM7SUFFRCw2RUFBNkU7SUFDN0UsV0FBVyxDQUFDLEtBQTZCLEVBQUUsS0FBMEI7UUFFbkUsbUVBQW1FO1FBQ25FLElBQUksS0FBSyxDQUFDLFdBQVcsSUFBSSxLQUFLLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ25ELE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDekMsUUFBUSxLQUFLLEVBQUU7Z0JBQ2IsS0FBSyx5QkFB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O1FBQ3BDLElBQUksQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDO0lBQ3BCLENBQUM7Q0FDTCxDQUFBOzhHQVRTLGlCQUFpQixrQkFlbEIsNEJBQTRCLGFBQzVCLDRCQUE0QixhQUM1QiwwQkFBMEI7a0hBakJ6QixpQkFBaUIsY0FGaEIsTUFBTTsyRkFFUCxpQkFBaUI7a0JBSDdCLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzswQkFnQkksTUFBTTsyQkFBQyw0QkFBNEI7OzBCQUNuQyxNQUFNOzJCQUFDLDRCQUE0Qjs7MEJBQ25DLE1BQU07MkJBQUMsMEJBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlU25hcHNob3QsIENhbkFjdGl2YXRlLCBSb3V0ZXJTdGF0ZVNuYXBzaG90IH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IEZhaWx1cmVMb2dpbkhhbmRsZXJJbnRlcmZhY2UgfSBmcm9tICcuL2hhbmRsZXIvZmFpbHVyZS1sb2dpbi1oYW5kbGVyLWludGVyZmFjZSc7XG5pbXBvcnQgeyBTdWNjZXNzTG9naW5IYW5kbGVySW50ZXJmYWNlIH0gZnJvbSAnLi9oYW5kbGVyL3N1Y2Nlc3MtbG9naW4taGFuZGxlci1pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUHJpc21lQW5ndWxhckNvbmZpZ3VyYXRpb24sIFBSSVNNRV9GQUlMVVJFX0xPR0lOX0hBTkRMRVIsIFBSSVNNRV9TVUNDRVNTX0xPR0lOX0hBTkRMRVIgfSBmcm9tICcuL3ByaXNtZS1hbmd1bGFyLmNvbmZpZyc7XG5pbXBvcnQgeyBMb2dpblNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2UvbG9naW4uc2VydmljZSc7XG5pbXBvcnQgeyBPYXV0aENhbGxiYWNrU2VydmljZSB9IGZyb20gJy4vc2VydmljZS9vYXV0aC1jYWxsYmFjay5zZXJ2aWNlJztcbmltcG9ydCB7IE9hdXRoU2VydmljZSB9IGZyb20gJy4vc2VydmljZS9vYXV0aC5zZXJ2aWNlJztcbmltcG9ydCB7IFJlZnJlc2hTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlL3JlZnJlc2guc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEF1dGhJbXBsaWNpdEd1YXJkIGltcGxlbWVudHMgQ2FuQWN0aXZhdGUge1xuICBzdGF0aWPCoFJlYWR5V2ViTWVzc2FnZcKgPcKgY2xhc3PCoHtcbiAgICAgICAgcHVibGljIHRvcGljOiBzdHJpbmc7XG4gICAgICAgIHB1YmxpYyBkYXRhOiBzdHJpbmc7XG5cbiAgICDCoMKgwqDCoGNvbnN0cnVjdG9yKGFUb3BpYzrCoHN0cmluZywgYURhdGE6IGFueSnCoHtcbiAgICAgICAgICB0aGlzLnRvcGljID0gYVRvcGljO1xuICAgICAgICAgIHRoaXMuZGF0YSA9IGFEYXRhO1xuICAgIMKgICAgfVxuICB9O1xuXG4gIGZhaWx1cmVMSDogRmFpbHVyZUxvZ2luSGFuZGxlckludGVyZmFjZTtcbiAgc3VjY2Vzc0xIOiBTdWNjZXNzTG9naW5IYW5kbGVySW50ZXJmYWNlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoUFJJU01FX1NVQ0NFU1NfTE9HSU5fSEFORExFUikgc3VjY2Vzc0xIOiBTdWNjZXNzTG9naW5IYW5kbGVySW50ZXJmYWNlLFxuICAgIEBJbmplY3QoUFJJU01FX0ZBSUxVUkVfTE9HSU5fSEFORExFUikgZmFpbHVyZUxIOiBGYWlsdXJlTG9naW5IYW5kbGVySW50ZXJmYWNlLFxuICAgIEBJbmplY3QoUHJpc21lQW5ndWxhckNvbmZpZ3VyYXRpb24pIHByaXZhdGUgZW52aXJvbm1lbnQ6IFByaXNtZUFuZ3VsYXJDb25maWd1cmF0aW9uLFxuICAgIHByaXZhdGUgb2F1dGhTZXJ2aWNlOiBPYXV0aFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBsb2dpblNlcnZpY2U6IExvZ2luU2VydmljZSxcbiAgICBwcml2YXRlIG9hdXRoQ2FsbEJhY2tTZXJ2aWNlOiBPYXV0aENhbGxiYWNrU2VydmljZSxcbiAgICBwcml2YXRlIHJlZnJlc2hTZXJ2aWNlOiBSZWZyZXNoU2VydmljZSxcbiAgICBwcml2YXRlIF9uZ1pvbmU6IE5nWm9uZVxuICApIHtcbiAgICB0aGlzLnN1Y2Nlc3NMSCA9IHN1Y2Nlc3NMSDtcbiAgICB0aGlzLmZhaWx1cmVMSCA9IGZhaWx1cmVMSDtcbiAgfVxuXG4gIC8vIE1ldGhvZGUgXCJHVUFSRFwiIGRldmFudCDDqnRyZSByw6lzb2x1ZSBwb3VyIGF2YW50IGwnYWNjw6hzIMOgIHVuZSBwYWdlIHByb3TDqWfDqWVcbiAgY2FuQWN0aXZhdGUocm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QsIHN0YXRlOiBSb3V0ZXJTdGF0ZVNuYXBzaG90KSAge1xuXG4gICAgLy8gRW4gY2FzIGQnZXJyZXVyLCBpbCB5IGEgZGVzIHF1ZXJ5UGFyYW1zIChub3RhbW1lbnQgXCI/ZXJyb3I9Li4uXCIpXG4gICAgaWYgKHJvdXRlLnF1ZXJ5UGFyYW1zICYmIHJvdXRlLnF1ZXJ5UGFyYW1zWydlcnJvciddKSB7XG4gICAgICBjb25zdCBlcnJvciA9IHJvdXRlLnF1ZXJ5UGFyYW1zWydlcnJvciddO1xuICAgICAgc3dpdGNoIChlcnJvcikge1xuICAgICAgICBjYXNlICdyZXNldF9wYXNzd29yZF9yZXF1aXJlZCc6IHtcbiAgICAgICAgICAvLyBDZWxhIHNpZ25pZmllIHF1ZSBsJ3V0aWxpc2F0ZXVyIGEgY2xpcXXDqSBzdXIgbGUgbGllbiBcIm1vdCBkZSBwYXNzZSBvdWJsacOpXCJcbiAgICAgICAgICBhbGVydCgnTGUgbW90IGRlIHBhc3NlIGRlIGNldHRlIGFwcGxpY2F0aW9uIGVzdCB2b3RyZSBtb3QgZGUgcGFzc2UgQW5haXMnKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBkZWZhdWx0OiB7XG4gICAgICAgICAgLy8gQ2VsYSBzaWduaWZpZSBxdSdpbCB5IGEgZXUgdW5lIGVycmV1clxuICAgICAgICAgIHRoaXMuZmFpbHVyZUxILmZhaWx1cmVMb2dpbih0aGlzLmxvZ2luU2VydmljZSk7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHRoaXMubG9naW5TZXJ2aWNlLmlzQ29ubmVjdGUoKSkge1xuICAgICAgdGhpcy5yZWZyZXNoU2VydmljZS5yZWxhbmNlclJhZnJhaWNoaXNzZW1lbnQoKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8vIEF1dGhlbnRpZmljYXRpb24gZGlyZWN0ZSB2aWEgV2ViTWVzc2FnZVxuICAgIC8vICh1biBmcmFnbWVudCBzcMOpY2lmaXF1ZSBwcsOpc2VudCBkYW5zIGwndXJsIHBlcm1ldCBkJ2FjdGl2ZXIgY2UgbW9kZSBkJ291dmVydHVyZSlcbiAgICBpZiAodGhpcy5vYXV0aFNlcnZpY2UuaXNEZWxlZ2F0ZWRPcGVuaW5nV2l0aFdlYk1lc3NhZ2Uocm91dGUuZnJhZ21lbnQpKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSB0aGlzLmNvbm5leGlvblZpYVdlYk1lc3NhZ2VIVE1MNSgpO1xuICAgICAgdGhpcy5zZW5kUmVhZHlXZWJNZXNzYWdlSFRNTDUoKTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG5cbiAgICAvLyBBdXRoZW50aWZpY2F0aW9uIGF2ZWMgdW4gZnJhZ21lbnQgcHLDqXNlbnQgZGFucyBsJ3VybFxuICAgIGlmIChyb3V0ZS5mcmFnbWVudCkge1xuICAgICAgcmV0dXJuIHRoaXMuY29ubmV4aW9uVmlhVVJMRnJhZ21lbnQocm91dGUuZnJhZ21lbnQpO1xuICAgIH1cblxuICAgIC8vIFJlZGlyZWN0aW9uIHZlcnMgbGEgbWlyZSBkJ2F1dGhlbnRpZmljYXRpb25cbiAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9IHRoaXMub2F1dGhTZXJ2aWNlLmF1dGhlbnRpZmljYXRpb25Gcm9udFVybChzdGF0ZS51cmwpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8vIE1vZGUgZGUgY29ubmV4aW9uIENyb3NzLURvbWFpbiB2aWEgcGFzc2FnZSBkZSBKZXRvbiBhdmVjIHVzYWdlIGR1IFdlYk1lc3NhZ2luZyBIVE1MNVxuICBwcml2YXRlIGNvbm5leGlvblZpYVdlYk1lc3NhZ2VIVE1MNSgpIHtcbiAgICBjb25zdCBteU9hdXRoQ2FsbEJhY2tTZXJ2aWNlID0gdGhpcy5vYXV0aENhbGxCYWNrU2VydmljZTtcbiAgICBjb25zdCBteVN1Y2Nlc3NMSCA9IHRoaXMuc3VjY2Vzc0xIO1xuICAgIGNvbnN0IG15RmFpbHVyZUxIID0gdGhpcy5mYWlsdXJlTEg7XG4gICAgY29uc3QgbXlSZWZyZXNoU2VydmljZSA9IHRoaXMucmVmcmVzaFNlcnZpY2U7XG4gICAgY29uc3QgbXlMb2dpblNlcnZpY2UgPSB0aGlzLmxvZ2luU2VydmljZTtcbiAgICBjb25zdCBteUVudmlyb25tZW50ID0gdGhpcy5lbnZpcm9ubWVudDtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8Ym9vbGVhbj4oZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAvLyBBam91dCBkJ3VuIGxpc3RlbmVyIGVuIGF0dGVudGUgZGVzIGV2ZW5lbWVudHMgZGUgdHlwZSAnbWVzc2FnZSdcbiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJyxcbiAgICAgICAgKGUpID0+IHtcbiAgICAgICAgICBpZiAoZS5kYXRhLnRvcGljID09PSBteUVudmlyb25tZW50LmpldG9uTWVzc2FnZVRvcGljICkge1xuICAgICAgICAgICAgY29uc3QgdG9rZW5WYWx1ZSA9IGUuZGF0YS50b2tlbl92YWx1ZTtcbiAgICAgICAgICAgIC8vIEEgbGEgcmVjZXB0aW9uIGQndW4gbWVzc2FnZSBkZSB0eXBlIHRva2VuLCBsYW5jZW1lbnQgZGVzIHRyYWl0ZW1lbnRzIGRlIGxvZ2luXG4gICAgICAgICAgICBpZiAoZS5kYXRhLnRva2VuX3R5cGUgPT09ICdqd3QnKSB7XG4gICAgICAgICAgICAgIG15T2F1dGhDYWxsQmFja1NlcnZpY2UuaGFuZGxlQWNjZXNzVG9rZW4oXG4gICAgICAgICAgICAgICAgdG9rZW5WYWx1ZSxcbiAgICAgICAgICAgICAgICAncG9ydGFpbCcsXG4gICAgICAgICAgICAgICAgKCkgPT4gbXlTdWNjZXNzTEguc3VjY2Vzc0xvZ2luKG15UmVmcmVzaFNlcnZpY2UpLFxuICAgICAgICAgICAgICAgICgpID0+IG15RmFpbHVyZUxILmZhaWx1cmVMb2dpbihteUxvZ2luU2VydmljZSkpXG4gICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgbXlSZWZyZXNoU2VydmljZS5pbml0aWVyUmFmcmFpY2hpc3NlbWVudCgpO1xuICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZS5kYXRhLnRva2VuX3R5cGUgPT09ICdvY2VhbicpIHtcbiAgICAgICAgICAgICAgbXlPYXV0aENhbGxCYWNrU2VydmljZS5oYW5kbGVKZXRvbk9jZWFuKFxuICAgICAgICAgICAgICAgIHRva2VuVmFsdWUsXG4gICAgICAgICAgICAgICAgKCkgPT4gbXlTdWNjZXNzTEguc3VjY2Vzc0xvZ2luKG15UmVmcmVzaFNlcnZpY2UpLFxuICAgICAgICAgICAgICAgICgpID0+IG15RmFpbHVyZUxILmZhaWx1cmVMb2dpbihteUxvZ2luU2VydmljZSkpXG4gICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgbXlSZWZyZXNoU2VydmljZS5pbml0aWVyUmFmcmFpY2hpc3NlbWVudCgpO1xuICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLy8gTW9kZSBkZSBjb25uZXhpb24gQ3Jvc3MtRG9tYWluIHZpYSBwYXNzYWdlIGRlIEpldG9uIGF2ZWMgdXNhZ2UgVVJMRnJhZ21lbnRcbiAgLy8gVXNhZ2UgbGltaXTDqSDDoCBkZXMgamV0b25zIDwya28gcG91ciBJRVxuICBwcml2YXRlIGNvbm5leGlvblZpYVVSTEZyYWdtZW50KHJvdXRlRnJhZ21lbnQ6IHN0cmluZykge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxib29sZWFuPigocmVzb2x2ZSkgPT4ge1xuICAgICAgdGhpcy5vYXV0aENhbGxCYWNrU2VydmljZVxuICAgICAgICAuaGFuZGxlRnJhZ21lbnQocm91dGVGcmFnbWVudCxcbiAgICAgICAgICAgICgpID0+IHRoaXMuc3VjY2Vzc0xILnN1Y2Nlc3NMb2dpbih0aGlzLnJlZnJlc2hTZXJ2aWNlKSxcbiAgICAgICAgICAgICgpID0+IHRoaXMuZmFpbHVyZUxILmZhaWx1cmVMb2dpbih0aGlzLmxvZ2luU2VydmljZSkpXG4gICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICB0aGlzLnJlZnJlc2hTZXJ2aWNlLmluaXRpZXJSYWZyYWljaGlzc2VtZW50KCk7XG4gICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgIH0pLmNhdGNoKCBmdW5jdGlvbigpIHsgfSk7IC8vIHByZXZlbnRzIFwiVW5jYXVnaHQgKGluIHByb21pc2UpIGVycm9yXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHNlbmRSZWFkeVdlYk1lc3NhZ2VIVE1MNSgpIHtcbiAgICBjb25zdCBtZXNzYWdlID0gbmV3IEF1dGhJbXBsaWNpdEd1YXJkLlJlYWR5V2ViTWVzc2FnZSh0aGlzLmVudmlyb25tZW50LmpldG9uUmVhZHlUb3BpYywgbnVsbCk7XG4gICAgd2luZG93LnBhcmVudC5wb3N0TWVzc2FnZShtZXNzYWdlLCAnKicpO1xuICB9XG5cbn1cblxuIl19