import { Inject, Injectable } from '@angular/core';
import * as pako from 'pako';
import { PrismeAngularConfiguration } from '../prisme-angular.config';
import * as i0 from "@angular/core";
import * as i1 from "../prisme-angular-init.config";
import * as i2 from "@angular/router";
import * as i3 from "../prisme-angular.config";
export class OauthService {
    constructor(environment, prismeAngularInitConfig, router) {
        this.environment = environment;
        this.prismeAngularInitConfig = prismeAngularInitConfig;
        this.router = router;
        /** Chaines spécifiques à OIDC */
        this.response_type = 'token id_token';
        this.grant_type_jwt = 'urn:ietf:params:oauth:grant-type:jwt-bearer';
        this.assertion_type_jwt = 'jwt_token';
        this.grant_type_ocean = 'ocean_bearer';
        this.assertion_type_ocean = 'ocean_token';
    }
    savePageFrom(url) {
        sessionStorage.setItem(this.prismeAngularInitConfig.cleStockagePageFrom, url);
    }
    /**
     * Renvoie l'URL vers la mire de login pour authentification
     */
    authentificationFrontUrl(url) {
        this.savePageFrom(url);
        const response_type = encodeURIComponent(this.response_type);
        const redirect_uri = encodeURIComponent(this.environment.applicationUri + '/retour_pss');
        const scope = encodeURIComponent(this.environment.prismeScopeFront);
        const client_id = this.environment.prismeCodeApp;
        const nonce = encodeURIComponent(this.randomString(OauthService.NONCE_LENGTH));
        const state = encodeURIComponent(this.randomString(OauthService.STATE_LENGTH));
        sessionStorage.setItem(this.prismeAngularInitConfig.cleStockageDernierNonce, nonce);
        sessionStorage.setItem(this.prismeAngularInitConfig.cleStockageDernierState, state);
        // Construction de l'URL vers la mire de login
        const url_endpointLogin = this.environment.prismeAuthzEndpoint;
        return url_endpointLogin + '?response_type=' + response_type
            + '&client_id=' + client_id
            + '&redirect_uri=' + redirect_uri
            + '&scope=' + scope
            + '&nonce=' + nonce
            + '&state=' + state;
    }
    /**
     * Renvoie un body de requête en mode assertion JWT
     * @param assertion Jeton
     */
    authentificationBackAssertionJwt(assertion) {
        const jwtRequestBody = {};
        jwtRequestBody.grant_type = this.grant_type_jwt;
        jwtRequestBody.client_id = this.environment.prismeClientId;
        jwtRequestBody.client_secret = this.environment.prismeClientSecret;
        jwtRequestBody.assertion_type = this.assertion_type_jwt;
        jwtRequestBody.assertion = assertion;
        // Le scope doit etre compressé puis encodé en base 64
        const compressed_scope = pako.gzip(this.environment.prismeScopeBack, { to: 'string' });
        jwtRequestBody.scope = btoa(compressed_scope);
        return jwtRequestBody;
    }
    /**
   * Renvoie un body de requête en mode assertion JWT
   * @param assertion Jeton
   */
    authentificationFrontAssertionOcean(assertion) {
        const jwtRequestBody = {};
        jwtRequestBody.grant_type = this.grant_type_ocean;
        jwtRequestBody.client_id = this.environment.prismeClientId;
        jwtRequestBody.client_secret = this.environment.prismeClientSecret;
        jwtRequestBody.assertion_type = this.assertion_type_ocean;
        jwtRequestBody.assertion = assertion;
        // Le scope doit etre compressé puis encodé en base 64
        const compressed_scope = pako.gzip(this.environment.prismeScopeFront, { to: 'string' });
        jwtRequestBody.scope = btoa(compressed_scope);
        return jwtRequestBody;
    }
    /**
     * Récupère la dernière valeur du Nonce.
     */
    getLastNonce() {
        return sessionStorage.getItem(this.prismeAngularInitConfig.cleStockageDernierNonce);
    }
    /**
     * Récupère la dernière valeur du state.
     */
    getLastState() {
        return sessionStorage.getItem(this.prismeAngularInitConfig.cleStockageDernierState);
    }
    /**
     * Génère une chaine aléatoire pour le nonce/state
     * @param length Longueur
     */
    randomString(length) {
        let text = '';
        const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_';
        for (let i = 0; i < length; i++) {
            text += possible.charAt(Math.floor(Math.random() * possible.length));
        }
        return text;
    }
    /**
     * Vérifie s'il s'agit d'une ouverture en mode connexion WebMessaging
     * @param fragmentValue Valeur d'URL Fragment
     */
    isDelegatedOpeningWithWebMessage(fragmentValue) {
        return this.environment.waitWebMessageURLFragment === fragmentValue;
    }
}
OauthService.NONCE_LENGTH = 50;
OauthService.STATE_LENGTH = 50;
OauthService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.1.0", ngImport: i0, type: OauthService, deps: [{ token: PrismeAngularConfiguration }, { token: i1.PrismeAngularInitConfig }, { token: i2.Router }], target: i0.ɵɵFactoryTarget.Injectable });
OauthService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.1.0", ngImport: i0, type: OauthService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.1.0", ngImport: i0, type: OauthService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i3.PrismeAngularConfiguration, decorators: [{
                    type: Inject,
                    args: [PrismeAngularConfiguration]
                }] }, { type: i1.PrismeAngularInitConfig }, { type: i2.Router }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2F1dGguc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2Fjb3NzL3ByaXNtZS1hbmd1bGFyLWludHJhbmV0L3NyYy9saWIvc2VydmljZS9vYXV0aC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRW5ELE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLDBCQUEwQixDQUFDOzs7OztBQU90RSxNQUFNLE9BQU8sWUFBWTtJQVl2QixZQUF3RCxXQUF1QyxFQUNyRix1QkFBZ0QsRUFDbEQsTUFBYztRQUZrQyxnQkFBVyxHQUFYLFdBQVcsQ0FBNEI7UUFDckYsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtRQUNsRCxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBVHRCLGlDQUFpQztRQUNoQixrQkFBYSxHQUFHLGdCQUFnQixDQUFDO1FBQ2pDLG1CQUFjLEdBQUcsNkNBQTZDLENBQUM7UUFDL0QsdUJBQWtCLEdBQUcsV0FBVyxDQUFDO1FBQ2pDLHFCQUFnQixHQUFHLGNBQWMsQ0FBQztRQUNsQyx5QkFBb0IsR0FBRyxhQUFhLENBQUM7SUFLdEQsQ0FBQztJQUVTLFlBQVksQ0FBQyxHQUFXO1FBQzlCLGNBQWMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLG1CQUFtQixFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ2hGLENBQUM7SUFDSDs7T0FFRztJQUNILHdCQUF3QixDQUFDLEdBQVc7UUFDbEMsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN2QixNQUFNLGFBQWEsR0FBRyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDN0QsTUFBTSxZQUFZLEdBQUcsa0JBQWtCLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLEdBQUcsYUFBYSxDQUFDLENBQUM7UUFDekYsTUFBTSxLQUFLLEdBQUcsa0JBQWtCLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3BFLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDO1FBRWpELE1BQU0sS0FBSyxHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7UUFDL0UsTUFBTSxLQUFLLEdBQUcsa0JBQWtCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztRQUUvRSxjQUFjLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyx1QkFBdUIsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNwRixjQUFjLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyx1QkFBdUIsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUVwRiw4Q0FBOEM7UUFDOUMsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLG1CQUFtQixDQUFDO1FBQy9ELE9BQU8saUJBQWlCLEdBQUcsaUJBQWlCLEdBQUcsYUFBYTtjQUN4RCxhQUFhLEdBQUcsU0FBUztjQUN6QixnQkFBZ0IsR0FBRyxZQUFZO2NBQy9CLFNBQVMsR0FBRyxLQUFLO2NBQ2pCLFNBQVMsR0FBRyxLQUFLO2NBQ2pCLFNBQVMsR0FBRyxLQUFLLENBQUM7SUFDeEIsQ0FBQztJQUVEOzs7T0FHRztJQUNILGdDQUFnQyxDQUFDLFNBQWlCO1FBQ2hELE1BQU0sY0FBYyxHQUFRLEVBQUUsQ0FBQztRQUUvQixjQUFjLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUM7UUFFaEQsY0FBYyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQztRQUMzRCxjQUFjLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsa0JBQWtCLENBQUM7UUFDbkUsY0FBYyxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUM7UUFFeEQsY0FBYyxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFFckMsc0RBQXNEO1FBRXRELE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGVBQWUsRUFBRSxFQUFDLEVBQUUsRUFBRSxRQUFRLEVBQUMsQ0FBQyxDQUFDO1FBQ3JGLGNBQWMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFFOUMsT0FBTyxjQUFjLENBQUM7SUFDeEIsQ0FBQztJQUVHOzs7S0FHRjtJQUNGLG1DQUFtQyxDQUFDLFNBQWlCO1FBQ25ELE1BQU0sY0FBYyxHQUFRLEVBQUUsQ0FBQztRQUUvQixjQUFjLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztRQUVsRCxjQUFjLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDO1FBQzNELGNBQWMsQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxrQkFBa0IsQ0FBQztRQUNuRSxjQUFjLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQztRQUUxRCxjQUFjLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztRQUVyQyxzREFBc0Q7UUFDdEQsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLEVBQUUsRUFBQyxFQUFFLEVBQUUsUUFBUSxFQUFDLENBQUMsQ0FBQztRQUN0RixjQUFjLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBRTlDLE9BQU8sY0FBYyxDQUFDO0lBQzFCLENBQUM7SUFFQzs7T0FFRztJQUNILFlBQVk7UUFDVixPQUFPLGNBQWMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLHVCQUF1QixDQUFDLENBQUM7SUFDdEYsQ0FBQztJQUVEOztPQUVHO0lBQ0gsWUFBWTtRQUNWLE9BQU8sY0FBYyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsdUJBQXVCLENBQUMsQ0FBQztJQUN0RixDQUFDO0lBRUQ7OztPQUdHO0lBQ0ssWUFBWSxDQUFDLE1BQWM7UUFDakMsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2QsTUFBTSxRQUFRLEdBQUcsa0VBQWtFLENBQUM7UUFDcEYsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUMvQixJQUFJLElBQUksUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztTQUN0RTtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVEOzs7T0FHRztJQUNJLGdDQUFnQyxDQUFDLGFBQXFCO1FBQzNELE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyx5QkFBeUIsS0FBSyxhQUFhLENBQUM7SUFDdEUsQ0FBQzs7QUExSHNCLHlCQUFZLEdBQUcsRUFBRyxDQUFBO0FBQ2xCLHlCQUFZLEdBQUcsRUFBRyxDQUFBO3lHQUg5QixZQUFZLGtCQVlILDBCQUEwQjs2R0FabkMsWUFBWSxjQUZYLE1BQU07MkZBRVAsWUFBWTtrQkFIeEIsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7OzBCQWFjLE1BQU07MkJBQUMsMEJBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0ICogYXMgcGFrbyBmcm9tICdwYWtvJztcbmltcG9ydCB7IFByaXNtZUFuZ3VsYXJDb25maWd1cmF0aW9uIH0gZnJvbSAnLi4vcHJpc21lLWFuZ3VsYXIuY29uZmlnJztcbmltcG9ydCB7IFByaXNtZUFuZ3VsYXJJbml0Q29uZmlnIH0gZnJvbSAnLi4vcHJpc21lLWFuZ3VsYXItaW5pdC5jb25maWcnO1xuXG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIE9hdXRoU2VydmljZSB7XG5cbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBOT05DRV9MRU5HVEggPSA1MDtcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBTVEFURV9MRU5HVEggPSA1MDtcblxuICAvKiogQ2hhaW5lcyBzcMOpY2lmaXF1ZXMgw6AgT0lEQyAqL1xuICBwcml2YXRlIHJlYWRvbmx5IHJlc3BvbnNlX3R5cGUgPSAndG9rZW4gaWRfdG9rZW4nO1xuICBwcml2YXRlIHJlYWRvbmx5IGdyYW50X3R5cGVfand0ID0gJ3VybjppZXRmOnBhcmFtczpvYXV0aDpncmFudC10eXBlOmp3dC1iZWFyZXInO1xuICBwcml2YXRlIHJlYWRvbmx5IGFzc2VydGlvbl90eXBlX2p3dCA9ICdqd3RfdG9rZW4nO1xuICBwcml2YXRlIHJlYWRvbmx5IGdyYW50X3R5cGVfb2NlYW4gPSAnb2NlYW5fYmVhcmVyJztcbiAgcHJpdmF0ZSByZWFkb25seSBhc3NlcnRpb25fdHlwZV9vY2VhbiA9ICdvY2Vhbl90b2tlbic7XG5cbiAgY29uc3RydWN0b3IoQEluamVjdChQcmlzbWVBbmd1bGFyQ29uZmlndXJhdGlvbikgcHJpdmF0ZSBlbnZpcm9ubWVudDogUHJpc21lQW5ndWxhckNvbmZpZ3VyYXRpb24sXG4gIHByb3RlY3RlZCBwcmlzbWVBbmd1bGFySW5pdENvbmZpZzogUHJpc21lQW5ndWxhckluaXRDb25maWcsXG4gIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIgKSB7XG4gIH1cblxuICAgIHByaXZhdGUgc2F2ZVBhZ2VGcm9tKHVybDogc3RyaW5nKSB7XG4gICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKHRoaXMucHJpc21lQW5ndWxhckluaXRDb25maWcuY2xlU3RvY2thZ2VQYWdlRnJvbSwgdXJsKTtcbiAgICB9XG4gIC8qKlxuICAgKiBSZW52b2llIGwnVVJMIHZlcnMgbGEgbWlyZSBkZSBsb2dpbiBwb3VyIGF1dGhlbnRpZmljYXRpb25cbiAgICovXG4gIGF1dGhlbnRpZmljYXRpb25Gcm9udFVybCh1cmw6IHN0cmluZykge1xuICAgIHRoaXMuc2F2ZVBhZ2VGcm9tKHVybCk7XG4gICAgY29uc3QgcmVzcG9uc2VfdHlwZSA9IGVuY29kZVVSSUNvbXBvbmVudCh0aGlzLnJlc3BvbnNlX3R5cGUpO1xuICAgIGNvbnN0IHJlZGlyZWN0X3VyaSA9IGVuY29kZVVSSUNvbXBvbmVudCh0aGlzLmVudmlyb25tZW50LmFwcGxpY2F0aW9uVXJpICsgJy9yZXRvdXJfcHNzJyk7XG4gICAgY29uc3Qgc2NvcGUgPSBlbmNvZGVVUklDb21wb25lbnQodGhpcy5lbnZpcm9ubWVudC5wcmlzbWVTY29wZUZyb250KTtcbiAgICBjb25zdCBjbGllbnRfaWQgPSB0aGlzLmVudmlyb25tZW50LnByaXNtZUNvZGVBcHA7XG5cbiAgICBjb25zdCBub25jZSA9IGVuY29kZVVSSUNvbXBvbmVudCh0aGlzLnJhbmRvbVN0cmluZyhPYXV0aFNlcnZpY2UuTk9OQ0VfTEVOR1RIKSk7XG4gICAgY29uc3Qgc3RhdGUgPSBlbmNvZGVVUklDb21wb25lbnQodGhpcy5yYW5kb21TdHJpbmcoT2F1dGhTZXJ2aWNlLlNUQVRFX0xFTkdUSCkpO1xuXG4gICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSh0aGlzLnByaXNtZUFuZ3VsYXJJbml0Q29uZmlnLmNsZVN0b2NrYWdlRGVybmllck5vbmNlLCBub25jZSk7XG4gICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSh0aGlzLnByaXNtZUFuZ3VsYXJJbml0Q29uZmlnLmNsZVN0b2NrYWdlRGVybmllclN0YXRlLCBzdGF0ZSk7XG5cbiAgICAvLyBDb25zdHJ1Y3Rpb24gZGUgbCdVUkwgdmVycyBsYSBtaXJlIGRlIGxvZ2luXG4gICAgY29uc3QgdXJsX2VuZHBvaW50TG9naW4gPSB0aGlzLmVudmlyb25tZW50LnByaXNtZUF1dGh6RW5kcG9pbnQ7XG4gICAgcmV0dXJuIHVybF9lbmRwb2ludExvZ2luICsgJz9yZXNwb25zZV90eXBlPScgKyByZXNwb25zZV90eXBlXG4gICAgICArICcmY2xpZW50X2lkPScgKyBjbGllbnRfaWRcbiAgICAgICsgJyZyZWRpcmVjdF91cmk9JyArIHJlZGlyZWN0X3VyaVxuICAgICAgKyAnJnNjb3BlPScgKyBzY29wZVxuICAgICAgKyAnJm5vbmNlPScgKyBub25jZVxuICAgICAgKyAnJnN0YXRlPScgKyBzdGF0ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW52b2llIHVuIGJvZHkgZGUgcmVxdcOqdGUgZW4gbW9kZSBhc3NlcnRpb24gSldUXG4gICAqIEBwYXJhbSBhc3NlcnRpb24gSmV0b25cbiAgICovXG4gIGF1dGhlbnRpZmljYXRpb25CYWNrQXNzZXJ0aW9uSnd0KGFzc2VydGlvbjogc3RyaW5nKSB7XG4gICAgY29uc3Qgand0UmVxdWVzdEJvZHk6IGFueSA9IHt9O1xuXG4gICAgand0UmVxdWVzdEJvZHkuZ3JhbnRfdHlwZSA9IHRoaXMuZ3JhbnRfdHlwZV9qd3Q7XG5cbiAgICBqd3RSZXF1ZXN0Qm9keS5jbGllbnRfaWQgPSB0aGlzLmVudmlyb25tZW50LnByaXNtZUNsaWVudElkO1xuICAgIGp3dFJlcXVlc3RCb2R5LmNsaWVudF9zZWNyZXQgPSB0aGlzLmVudmlyb25tZW50LnByaXNtZUNsaWVudFNlY3JldDtcbiAgICBqd3RSZXF1ZXN0Qm9keS5hc3NlcnRpb25fdHlwZSA9IHRoaXMuYXNzZXJ0aW9uX3R5cGVfand0O1xuXG4gICAgand0UmVxdWVzdEJvZHkuYXNzZXJ0aW9uID0gYXNzZXJ0aW9uO1xuXG4gICAgLy8gTGUgc2NvcGUgZG9pdCBldHJlIGNvbXByZXNzw6kgcHVpcyBlbmNvZMOpIGVuIGJhc2UgNjRcblxuICAgIGNvbnN0IGNvbXByZXNzZWRfc2NvcGUgPSBwYWtvLmd6aXAodGhpcy5lbnZpcm9ubWVudC5wcmlzbWVTY29wZUJhY2ssIHt0bzogJ3N0cmluZyd9KTtcbiAgICBqd3RSZXF1ZXN0Qm9keS5zY29wZSA9IGJ0b2EoY29tcHJlc3NlZF9zY29wZSk7XG5cbiAgICByZXR1cm4gand0UmVxdWVzdEJvZHk7XG4gIH1cblxuICAgICAgLyoqXG5cdCAqIFJlbnZvaWUgdW4gYm9keSBkZSByZXF1w6p0ZSBlbiBtb2RlIGFzc2VydGlvbiBKV1Rcblx0ICogQHBhcmFtIGFzc2VydGlvbiBKZXRvblxuXHQgKi9cbiAgYXV0aGVudGlmaWNhdGlvbkZyb250QXNzZXJ0aW9uT2NlYW4oYXNzZXJ0aW9uOiBzdHJpbmcpIHtcbiAgICBjb25zdCBqd3RSZXF1ZXN0Qm9keTogYW55ID0ge307XG5cbiAgICBqd3RSZXF1ZXN0Qm9keS5ncmFudF90eXBlID0gdGhpcy5ncmFudF90eXBlX29jZWFuO1xuXG4gICAgand0UmVxdWVzdEJvZHkuY2xpZW50X2lkID0gdGhpcy5lbnZpcm9ubWVudC5wcmlzbWVDbGllbnRJZDtcbiAgICBqd3RSZXF1ZXN0Qm9keS5jbGllbnRfc2VjcmV0ID0gdGhpcy5lbnZpcm9ubWVudC5wcmlzbWVDbGllbnRTZWNyZXQ7XG4gICAgand0UmVxdWVzdEJvZHkuYXNzZXJ0aW9uX3R5cGUgPSB0aGlzLmFzc2VydGlvbl90eXBlX29jZWFuO1xuXG4gICAgand0UmVxdWVzdEJvZHkuYXNzZXJ0aW9uID0gYXNzZXJ0aW9uO1xuXG4gICAgLy8gTGUgc2NvcGUgZG9pdCBldHJlIGNvbXByZXNzw6kgcHVpcyBlbmNvZMOpIGVuIGJhc2UgNjRcbiAgICBjb25zdCBjb21wcmVzc2VkX3Njb3BlID0gcGFrby5nemlwKHRoaXMuZW52aXJvbm1lbnQucHJpc21lU2NvcGVGcm9udCwge3RvOiAnc3RyaW5nJ30pO1xuICAgIGp3dFJlcXVlc3RCb2R5LnNjb3BlID0gYnRvYShjb21wcmVzc2VkX3Njb3BlKTtcblxuICAgIHJldHVybiBqd3RSZXF1ZXN0Qm9keTtcbn1cblxuICAvKipcbiAgICogUsOpY3Vww6hyZSBsYSBkZXJuacOocmUgdmFsZXVyIGR1IE5vbmNlLlxuICAgKi9cbiAgZ2V0TGFzdE5vbmNlKCkge1xuICAgIHJldHVybiBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKHRoaXMucHJpc21lQW5ndWxhckluaXRDb25maWcuY2xlU3RvY2thZ2VEZXJuaWVyTm9uY2UpO1xuICB9XG5cbiAgLyoqXG4gICAqIFLDqWN1cMOocmUgbGEgZGVybmnDqHJlIHZhbGV1ciBkdSBzdGF0ZS5cbiAgICovXG4gIGdldExhc3RTdGF0ZSgpIHtcbiAgICByZXR1cm4gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSh0aGlzLnByaXNtZUFuZ3VsYXJJbml0Q29uZmlnLmNsZVN0b2NrYWdlRGVybmllclN0YXRlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHw6luw6hyZSB1bmUgY2hhaW5lIGFsw6lhdG9pcmUgcG91ciBsZSBub25jZS9zdGF0ZVxuICAgKiBAcGFyYW0gbGVuZ3RoIExvbmd1ZXVyXG4gICAqL1xuICBwcml2YXRlIHJhbmRvbVN0cmluZyhsZW5ndGg6IG51bWJlcikge1xuICAgIGxldCB0ZXh0ID0gJyc7XG4gICAgY29uc3QgcG9zc2libGUgPSAnQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVphYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ejAxMjM0NTY3ODktXyc7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgICAgdGV4dCArPSBwb3NzaWJsZS5jaGFyQXQoTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogcG9zc2libGUubGVuZ3RoKSk7XG4gICAgfVxuICAgIHJldHVybiB0ZXh0O1xuICB9XG5cbiAgLyoqXG4gICAqIFbDqXJpZmllIHMnaWwgcydhZ2l0IGQndW5lIG91dmVydHVyZSBlbiBtb2RlIGNvbm5leGlvbiBXZWJNZXNzYWdpbmdcbiAgICogQHBhcmFtIGZyYWdtZW50VmFsdWUgVmFsZXVyIGQnVVJMIEZyYWdtZW50XG4gICAqL1xuICBwdWJsaWMgaXNEZWxlZ2F0ZWRPcGVuaW5nV2l0aFdlYk1lc3NhZ2UoZnJhZ21lbnRWYWx1ZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuZW52aXJvbm1lbnQud2FpdFdlYk1lc3NhZ2VVUkxGcmFnbWVudCA9PT0gZnJhZ21lbnRWYWx1ZTtcbiAgfVxuXG59XG5cbiJdfQ==