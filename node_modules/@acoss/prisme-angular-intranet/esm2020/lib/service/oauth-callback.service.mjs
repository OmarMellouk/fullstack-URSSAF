import { HttpHeaders } from '@angular/common/http';
import { Inject, Injectable } from '@angular/core';
import { PrismeAngularConfiguration } from '../prisme-angular.config';
import * as i0 from "@angular/core";
import * as i1 from "./oauth.service";
import * as i2 from "./login.service";
import * as i3 from "./oauth-validation.service";
import * as i4 from "@angular/common/http";
import * as i5 from "./access-token.service";
import * as i6 from "../prisme-angular.config";
const ALGO_VALIDATION = 'RS512';
export class OauthCallbackService {
    constructor(environment, oauthService, loginService, oauthValidationService, http, accessTokenService) {
        this.environment = environment;
        this.oauthService = oauthService;
        this.loginService = loginService;
        this.oauthValidationService = oauthValidationService;
        this.http = http;
        this.accessTokenService = accessTokenService;
    }
    handleFragment(fragment, callBackSucces, callBackErreur) {
        // Parsing du fragment (séparation des champs)
        const champs = decodeURIComponent(fragment).split('&');
        const params = [];
        champs.forEach(function (value) {
            // Parsing des champs du fragment
            if (value.indexOf('=') !== -1) {
                const champ_tokens = value.split('=');
                params[champ_tokens[0]] = champ_tokens[1];
            }
        });
        // Récupération Access Token
        const access_token_str = params['access_token'];
        const ocean_token_str = params['data'];
        // Si tout s'est bien passé, on a l'un des 2 jetons
        if (access_token_str) {
            const state = params['state'];
            let mode_authentification = '';
            if (state) {
                // si on a un state alors on est dans la cynématique implicit
                // Voir OauthService.authentificationFrontUrl
                mode_authentification = 'implicit';
                // Si le fragment vient de la mire PSS alors on peut le valider
                if (state !== this.oauthService.getLastState()) {
                    console.error('State invalide, il ne correspond pas à la requête.');
                    callBackErreur();
                    return Promise.reject(new Error('StateInvalid'));
                }
            }
            else {
                mode_authentification = 'portail';
            }
            return this.handleAccessToken(access_token_str, mode_authentification, callBackSucces, callBackErreur);
        }
        else if (ocean_token_str) {
            return this.handleJetonOcean(ocean_token_str, callBackSucces, callBackErreur);
        }
        else {
            // Sinon il y a eu une erreur
            console.error('Erreur pendant la récupération du jeton d\'accès FRONT depuis le portail : jeton non trouvé');
            callBackErreur();
        }
    }
    handleAccessToken(access_token_front_str, mode_authentification, callBackSucces, callBackErreur) {
        return new Promise((resolve, reject) => {
            const headers = new HttpHeaders();
            headers.append('Content-type', 'application/json');
            const options = { headers: headers };
            let identifiantUtilisateur = '';
            try {
                identifiantUtilisateur = this.accessTokenService.getIdentifiantUtilisateur(access_token_front_str);
            }
            catch (err) {
                // Traitement en cas d'erreur decodage du jeton
                callBackErreur();
                reject(err);
            }
            // Validation du jeton - Récupération des clés
            this.http.get(this.environment.prismeKeysEndpoint).subscribe((keysResult) => {
                this.pssPublicKeys = keysResult.keys;
                // On peut maintenant échanger le jeton FRONT contre un jeton BACK
                this.http.post(this.environment.prismeTokenEndpoint, this.oauthService.authentificationBackAssertionJwt(access_token_front_str), options).subscribe((body) => {
                    // Récupération du jeton
                    const access_token_back_str = body.access_token;
                    // Validation
                    if (!this.validateJeton(access_token_back_str, this.pssPublicKeys)) {
                        callBackErreur();
                        resolve('erreur');
                        return;
                    }
                    // Mise à jour de la valeur d'expiration
                    const expirationTime = this.calculateExpirationTime(body.expires_in);
                    const tokenData = {
                        accessTokenBack: access_token_back_str,
                        accessTokenFront: access_token_front_str,
                        oceanToken: null,
                        expiration: expirationTime,
                        infosUtilisateurFront: null,
                        infosUtilisateurBack: null,
                        mode: mode_authentification,
                        payload: null
                    };
                    this.loginService.storeInfos(tokenData);
                    // Appel du service user-infos pour avoir les infos utilisateur bak
                    this.updateInfosUtilisateur(identifiantUtilisateur, callBackSucces, callBackErreur, resolve);
                }, (err) => {
                    console.error('Erreur pendant l\'authentification : échec du JWT Assertion');
                    if (err.error) {
                        console.error('[ ' + err.error.error_code + ' ] ' + err.error.error_message);
                    }
                    callBackErreur();
                    resolve('erreur');
                });
            }, (err) => {
                console.error('Erreur lors de la récupération des clés publiques PSS');
                console.error(err);
                callBackErreur();
                resolve('erreur');
            });
        });
    }
    /**
     * Traitement du jeton
     * @param ocean_token_str Jeton
     * @param callBackSucces Méthode si traitement OK
     * @param callBackErreur Méthode si traitement KO
     */
    handleJetonOcean(ocean_token_str, callBackSucces, callBackErreur) {
        return new Promise((resolve, reject) => {
            /** On l'échange contre un jeton front */
            const headers = new HttpHeaders();
            headers.append('Content-type', 'application/json');
            const options = { headers: headers };
            this.http.post(this.environment.prismeTokenEndpoint, this.oauthService.authentificationFrontAssertionOcean(ocean_token_str), options).subscribe((bodyFront) => {
                // Récupération du jeton
                const access_token_front_str = bodyFront.access_token;
                const access_token_front_decode = this.accessTokenService.decodeAccessToken(access_token_front_str);
                // Validation du jeton - Récupération des clés
                this.http.get(this.environment.prismeKeysEndpoint).subscribe((keysResult) => {
                    this.pssPublicKeys = keysResult.keys;
                    // Validation du jeton
                    if (!this.validateJeton(access_token_front_str, this.pssPublicKeys)) {
                        callBackErreur();
                        resolve('erreur');
                        return;
                    }
                    if (!this.oauthValidationService.validerSubOcean(access_token_front_decode, this.environment.prismeClientId)) {
                        console.error('Contrôle du jeton d\'accès FRONT : SUB non valide');
                        callBackErreur();
                        resolve('erreur');
                        return;
                    }
                    // On peut maintenant échanger le jeton FRONT contre un jeton BACK
                    this.http.post(this.environment.prismeTokenEndpoint, this.oauthService.authentificationBackAssertionJwt(access_token_front_str), options).subscribe((bodyBack) => {
                        // Récupération du jeton
                        const access_token_back_str = bodyBack.access_token;
                        // Validation du jeton
                        if (!this.validateJeton(access_token_back_str, this.pssPublicKeys)) {
                            callBackErreur();
                            resolve('erreur');
                            return;
                        }
                        // Mise à jour de la valeur d'expiration
                        const expirationTime = this.calculateExpirationTime(bodyBack.expires_in);
                        // Login
                        const tokenData = {
                            accessTokenBack: access_token_back_str,
                            accessTokenFront: access_token_front_str,
                            oceanToken: ocean_token_str,
                            expiration: expirationTime,
                            infosUtilisateurFront: null,
                            infosUtilisateurBack: null,
                            mode: 'ocean',
                            payload: null
                        };
                        this.loginService.storeInfos(tokenData);
                        // Appel du service user-infos pour avoir les infos utilisateur
                        const identifiantUtilisateur = this.accessTokenService.getIdentifiantUtilisateur(access_token_front_str);
                        this.updateInfosUtilisateur(identifiantUtilisateur, callBackSucces, callBackErreur, resolve);
                    }, (err) => {
                        console.error('Erreur pendant l\'authentification : échec du JWT Assertion');
                        if (err.error_message) {
                            console.error('[ ' + err.error_code + ' ] ' + err.error_message);
                        }
                        callBackErreur();
                        resolve('erreur');
                    });
                }, (err) => {
                    console.error('Erreur lors de la récupération des clés publiques PSS');
                    console.error(err);
                    callBackErreur();
                    resolve('erreur');
                });
            }, (err) => {
                console.error('Erreur HTTP');
                console.error(err);
                callBackErreur();
                resolve('erreur');
            });
        });
    }
    /**
     * Méthode de renovellement d'un jeton
     * @param access_token_front_str le jeton à renouveller
     */
    renewAccessTokenPortail(access_token_front_str) {
        return new Promise((resolve, reject) => {
            if (this.pssPublicKeys) {
                this.renewAccessToken(access_token_front_str, this.pssPublicKeys, resolve, reject);
            }
            else {
                // Récupération des clés pour valider le jeton
                this.http.get(this.environment.prismeKeysEndpoint).subscribe((keysResult) => {
                    this.pssPublicKeys = keysResult.keys;
                    this.renewAccessToken(access_token_front_str, this.pssPublicKeys, resolve, reject);
                }, (err) => {
                    console.error('Erreur lors de la récupération des clés publiques PSS');
                    console.error(err);
                    // Rejet de la promise pour stopper le rafraichissement car on a une erreur
                    reject(err);
                });
            }
        });
    }
    /**
     * Méthode de renovellement d'un jeton
     * @param access_token_front_str  le jeton à renouveller
     * @param publicKeys les clés pour valider le jeton
     * @param resolve méthode pour indiquer que le renouvellement est terminé
     * @param reject méthode pour indiquer qu'une erreur est survenue lors du renouvellement
     */
    renewAccessToken(access_token_front_str, publicKeys, resolve, reject) {
        // On peut maintenant échanger le jeton FRONT contre un jeton BACK
        const headers = new HttpHeaders();
        headers.append('Content-type', 'application/json');
        const options = { headers: headers };
        this.http.post(this.environment.prismeTokenEndpoint, this.oauthService.authentificationBackAssertionJwt(access_token_front_str), options).subscribe((body) => {
            // Récupération du jeton
            const access_token_back_str = body.access_token;
            // Validation
            if (!this.validateJeton(access_token_back_str, publicKeys)) {
                reject('jeton invalide');
            }
            // Mise à jour de la valeur d'expiration
            const expirationTime = this.calculateExpirationTime(body.expires_in);
            this.loginService.updateAccessToken(access_token_back_str, expirationTime);
            // Resolve de la promise pour indiquer que le refresh est ok
            resolve(true);
        }, (err) => {
            console.error('Erreur pendant l\'authentification : échec du JWT Assertion');
            if (err.error) {
                console.error('[ ' + err.error.error_code + ' ] ' + err.error.error_message);
            }
            // Rejet de la promise pour stopper le rafraichissement car on a une erreur
            reject(err);
        });
    }
    /**
     * Validation du jeton : voir la documentation JWT Assertion
     * @param access_token_back_str le jeton
     * @param access_token_back_decode le jeton décodé
     * @param publicKeys les clés
     */
    validateJeton(access_token_back_str, publicKeys) {
        const access_token_back_decode = this.accessTokenService.decodeAccessToken(access_token_back_str);
        // Validation du jeton : voir la documentation JWT Assertion
        if (!this.oauthValidationService.validerIss(access_token_back_decode)) {
            console.error('Contrôle du jeton d\'accès : ISS non valide');
            return false;
        }
        if (!this.oauthValidationService.validerExp(access_token_back_decode)) {
            console.error('Contrôle du jeton d\'accès : EXP non valide');
            return false;
        }
        if (!this.oauthValidationService.validerAudNonVide(access_token_back_decode)) {
            console.error('Contrôle du jeton d\'accès : AUD non valide');
            return false;
        }
        if (!this.oauthValidationService.validerSignature(access_token_back_str, publicKeys, ALGO_VALIDATION)) {
            console.error('Contrôle du jeton d\'accès : Signature non valide');
            return false;
        }
        return true;
    }
    /**
     * calcule la date d'expiration du jeton
     * @param expiresInNum la durée de validité du jeton
     */
    calculateExpirationTime(expiresInNum) {
        const expirationDate = new Date();
        expirationDate.setSeconds(expirationDate.getSeconds() + expiresInNum);
        return expirationDate;
    }
    /**
     * Met à jour les données utilisateur en utilisateur le service user-infos
     * @param identifiantUtilisateur le user
     * @param callBackSucces le callback si tout est ok
     * @param callBackErreur le callback d'erreur
     * @param resolve provient de la promise retournée par ce service OauthCallbackService
     */
    updateInfosUtilisateur(identifiantUtilisateur, callBackSucces, callBackErreur, resolve) {
        if (this.environment.chargerUserInfosBack) {
            this.getUserInfoObservable(identifiantUtilisateur, this.loginService.getAccessTokenBack()).subscribe(bodyUser => {
                this.loginService.updateInfosUtilisateurBack(bodyUser);
                if (this.environment.chargerUserInfosFront) {
                    this.updateInfosUtilisateurFront(identifiantUtilisateur, callBackSucces, callBackErreur, resolve);
                }
                else {
                    callBackSucces();
                    resolve('sucess');
                }
            }, err => this.handlerUserInfoError(err, callBackErreur, resolve));
        }
        else if (this.environment.chargerUserInfosFront) {
            this.updateInfosUtilisateurFront(identifiantUtilisateur, callBackSucces, callBackErreur, resolve);
        }
        else {
            callBackSucces();
            resolve('sucess');
        }
    }
    /**
     * Permet de réaliser un appel à user-info avec uun access token front et de mettre à jour les informations utilisateur
     * @param identifiantUtilisateur le user
     * @param callBackSucces le callback si tout est ok
     * @param callBackErreur le callback d'erreur
     * @param resolve provient de la promise retournée par ce service OauthCallbackService
     */
    updateInfosUtilisateurFront(identifiantUtilisateur, callBackSucces, callBackErreur, resolve) {
        this.getUserInfoObservable(identifiantUtilisateur, this.loginService.getAccessTokenFront()).subscribe(result => {
            this.loginService.updateInfosUtilisateurFront(result);
            callBackSucces();
            resolve('sucess');
        }, err => this.handlerUserInfoError(err, callBackErreur, resolve));
    }
    /**
     * Permet de réaliser l'appel au service user-ifnos
     * @param identifiantUtilisateur le user
     * @param token le token d'authentification
     */
    getUserInfoObservable(identifiantUtilisateur, token) {
        const requestHeaders = {
            headers: new HttpHeaders({
                'Content-type': 'application/json',
                'Authorization': 'Bearer ' + token
            })
        };
        return this.http.post(this.environment.prismeUserEndpoint, { 'username': identifiantUtilisateur }, requestHeaders);
    }
    /**
     * Permet de gérer les messages d'erreurs du service user-infos
     * @param err le message de retour du service
     * @param callBackErreur le callback d'erreur
     * @param resolve provient de la promise retournée par ce service OauthCallbackService
     */
    handlerUserInfoError(err, callBackErreur, resolve) {
        console.error('Erreur pendant l\'authentification : échec du user-info');
        if (err.error) {
            console.error('[ ' + err.error.error_code + ' ] ' + err.error.error_message);
        }
        callBackErreur();
        resolve('erreur');
    }
}
OauthCallbackService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.1.0", ngImport: i0, type: OauthCallbackService, deps: [{ token: PrismeAngularConfiguration }, { token: i1.OauthService }, { token: i2.LoginService }, { token: i3.OauthValidationService }, { token: i4.HttpClient }, { token: i5.AccessTokenService }], target: i0.ɵɵFactoryTarget.Injectable });
OauthCallbackService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.1.0", ngImport: i0, type: OauthCallbackService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.1.0", ngImport: i0, type: OauthCallbackService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i6.PrismeAngularConfiguration, decorators: [{
                    type: Inject,
                    args: [PrismeAngularConfiguration]
                }] }, { type: i1.OauthService }, { type: i2.LoginService }, { type: i3.OauthValidationService }, { type: i4.HttpClient }, { type: i5.AccessTokenService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2F1dGgtY2FsbGJhY2suc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2Fjb3NzL3ByaXNtZS1hbmd1bGFyLWludHJhbmV0L3NyYy9saWIvc2VydmljZS9vYXV0aC1jYWxsYmFjay5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBYyxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVuRCxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQzs7Ozs7Ozs7QUFNdEUsTUFBTSxlQUFlLEdBQUcsT0FBTyxDQUFDO0FBS2hDLE1BQU0sT0FBTyxvQkFBb0I7SUFJL0IsWUFBd0QsV0FBdUMsRUFDM0UsWUFBMEIsRUFDMUIsWUFBMEIsRUFDMUIsc0JBQThDLEVBQzlDLElBQWdCLEVBQ2hCLGtCQUFzQztRQUxGLGdCQUFXLEdBQVgsV0FBVyxDQUE0QjtRQUMzRSxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQiwyQkFBc0IsR0FBdEIsc0JBQXNCLENBQXdCO1FBQzlDLFNBQUksR0FBSixJQUFJLENBQVk7UUFDaEIsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtJQUMxRCxDQUFDO0lBRUQsY0FBYyxDQUFDLFFBQWdCLEVBQUUsY0FBMEIsRUFBRSxjQUEwQjtRQUVyRiw4Q0FBOEM7UUFDOUMsTUFBTSxNQUFNLEdBQUcsa0JBQWtCLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRXZELE1BQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUNsQixNQUFNLENBQUMsT0FBTyxDQUFDLFVBQVMsS0FBSztZQUMzQixpQ0FBaUM7WUFDakMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFD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LEVBQUUsT0FBWTtRQUM3RSxPQUFPLENBQUMsS0FBSyxDQUFDLHlEQUF5RCxDQUFDLENBQUM7UUFDekUsSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFO1lBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUcsS0FBSyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLENBQUM7U0FDOUU7UUFDRCxjQUFjLEVBQUUsQ0FBQztRQUNqQixPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDcEIsQ0FBQzs7aUhBcGFVLG9CQUFvQixrQkFJWCwwQkFBMEI7cUhBSm5DLG9CQUFvQixjQUZuQixNQUFNOzJGQUVQLG9CQUFvQjtrQkFIaEMsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7OzBCQUtjLE1BQU07MkJBQUMsMEJBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFByaXNtZUFuZ3VsYXJDb25maWd1cmF0aW9uIH0gZnJvbSAnLi4vcHJpc21lLWFuZ3VsYXIuY29uZmlnJztcbmltcG9ydCB7IEFjY2Vzc1Rva2VuU2VydmljZSB9IGZyb20gJy4vYWNjZXNzLXRva2VuLnNlcnZpY2UnO1xuaW1wb3J0IHsgTG9naW5TZXJ2aWNlLCBTZXNzaW9uVXRpbGlzYXRldXIgfSBmcm9tICcuL2xvZ2luLnNlcnZpY2UnO1xuaW1wb3J0IHsgT2F1dGhWYWxpZGF0aW9uU2VydmljZSB9IGZyb20gJy4vb2F1dGgtdmFsaWRhdGlvbi5zZXJ2aWNlJztcbmltcG9ydCB7IE9hdXRoU2VydmljZSB9IGZyb20gJy4vb2F1dGguc2VydmljZSc7XG5cbmNvbnN0IEFMR09fVkFMSURBVElPTiA9ICdSUzUxMic7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIE9hdXRoQ2FsbGJhY2tTZXJ2aWNlIHtcblxuICBwcml2YXRlIHBzc1B1YmxpY0tleXM6IGFueTtcblxuICBjb25zdHJ1Y3RvcihASW5qZWN0KFByaXNtZUFuZ3VsYXJDb25maWd1cmF0aW9uKSBwcml2YXRlIGVudmlyb25tZW50OiBQcmlzbWVBbmd1bGFyQ29uZmlndXJhdGlvbixcbiAgICAgICAgICAgICAgcHJpdmF0ZSBvYXV0aFNlcnZpY2U6IE9hdXRoU2VydmljZSxcbiAgICAgICAgICAgICAgcHJpdmF0ZSBsb2dpblNlcnZpY2U6IExvZ2luU2VydmljZSxcbiAgICAgICAgICAgICAgcHJpdmF0ZSBvYXV0aFZhbGlkYXRpb25TZXJ2aWNlOiBPYXV0aFZhbGlkYXRpb25TZXJ2aWNlLFxuICAgICAgICAgICAgICBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsXG4gICAgICAgICAgICAgIHByaXZhdGUgYWNjZXNzVG9rZW5TZXJ2aWNlOiBBY2Nlc3NUb2tlblNlcnZpY2UpIHtcbiAgfVxuXG4gIGhhbmRsZUZyYWdtZW50KGZyYWdtZW50OiBzdHJpbmcsIGNhbGxCYWNrU3VjY2VzOiAoKSA9PiB2b2lkLCBjYWxsQmFja0VycmV1cjogKCkgPT4gdm9pZCk6IFByb21pc2U8YW55PiB7XG5cbiAgICAvLyBQYXJzaW5nIGR1IGZyYWdtZW50IChzw6lwYXJhdGlvbiBkZXMgY2hhbXBzKVxuICAgIGNvbnN0IGNoYW1wcyA9IGRlY29kZVVSSUNvbXBvbmVudChmcmFnbWVudCkuc3BsaXQoJyYnKTtcblxuICAgIGNvbnN0IHBhcmFtcyA9IFtdO1xuICAgIGNoYW1wcy5mb3JFYWNoKGZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICAvLyBQYXJzaW5nIGRlcyBjaGFtcHMgZHUgZnJhZ21lbnRcbiAgICAgIGlmICh2YWx1ZS5pbmRleE9mKCc9JykgIT09IC0xKSB7XG4gICAgICAgIGNvbnN0IGNoYW1wX3Rva2VucyA9IHZhbHVlLnNwbGl0KCc9Jyk7XG4gICAgICAgIHBhcmFtc1tjaGFtcF90b2tlbnNbMF1dID0gY2hhbXBfdG9rZW5zWzFdO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gUsOpY3Vww6lyYXRpb24gQWNjZXNzIFRva2VuXG4gICAgY29uc3QgYWNjZXNzX3Rva2VuX3N0ciA9IHBhcmFtc1snYWNjZXNzX3Rva2VuJ107XG4gICAgY29uc3Qgb2NlYW5fdG9rZW5fc3RyID0gcGFyYW1zWydkYXRhJ107XG5cbiAgICAvLyBTaSB0b3V0IHMnZXN0IGJpZW4gcGFzc8OpLCBvbiBhIGwndW4gZGVzIDIgamV0b25zXG4gICAgaWYgKGFjY2Vzc190b2tlbl9zdHIpIHtcblxuICAgICAgY29uc3Qgc3RhdGUgPSBwYXJhbXNbJ3N0YXRlJ107XG4gICAgICBsZXQgbW9kZV9hdXRoZW50aWZpY2F0aW9uID0gJyc7XG5cbiAgICAgIGlmIChzdGF0ZSkge1xuICAgICAgICAvLyBzaSBvbiBhIHVuIHN0YXRlIGFsb3JzIG9uIGVzdCBkYW5zIGxhIGN5bsOpbWF0aXF1ZSBpbXBsaWNpdFxuICAgICAgICAvLyBWb2lyIE9hdXRoU2VydmljZS5hdXRoZW50aWZpY2F0aW9uRnJvbnRVcmxcbiAgICAgICAgbW9kZV9hdXRoZW50aWZpY2F0aW9uID0gJ2ltcGxpY2l0JztcbiAgICAgICAgLy8gU2kgbGUgZnJhZ21lbnQgdmllbnQgZGUgbGEgbWlyZSBQU1MgYWxvcnMgb24gcGV1dCBsZSB2YWxpZGVyXG4gICAgICAgIGlmIChzdGF0ZSAhPT0gdGhpcy5vYXV0aFNlcnZpY2UuZ2V0TGFzdFN0YXRlKCkpIHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdTdGF0ZSBpbnZhbGlkZSwgaWwgbmUgY29ycmVzcG9uZCBwYXMgw6AgbGEgcmVxdcOqdGUuJyk7XG4gICAgICAgICAgY2FsbEJhY2tFcnJldXIoKTtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdTdGF0ZUludmFsaWQnKSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG1vZGVfYXV0aGVudGlmaWNhdGlvbiA9ICdwb3J0YWlsJztcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlQWNjZXNzVG9rZW4oYWNjZXNzX3Rva2VuX3N0ciwgbW9kZV9hdXRoZW50aWZpY2F0aW9uLCBjYWxsQmFja1N1Y2NlcywgY2FsbEJhY2tFcnJldXIpO1xuXG4gICAgfSBlbHNlIGlmIChvY2Vhbl90b2tlbl9zdHIpIHtcbiAgICAgIHJldHVybiB0aGlzLmhhbmRsZUpldG9uT2NlYW4ob2NlYW5fdG9rZW5fc3RyLCBjYWxsQmFja1N1Y2NlcywgY2FsbEJhY2tFcnJldXIpO1xuXG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFNpbm9uIGlsIHkgYSBldSB1bmUgZXJyZXVyXG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJldXIgcGVuZGFudCBsYSByw6ljdXDDqXJhdGlvbiBkdSBqZXRvbiBkXFwnYWNjw6hzIEZST05UIGRlcHVpcyBsZSBwb3J0YWlsIDogamV0b24gbm9uIHRyb3V2w6knKTtcbiAgICAgIGNhbGxCYWNrRXJyZXVyKCk7XG4gICAgfVxuICB9XG5cbiAgaGFuZGxlQWNjZXNzVG9rZW4oYWNjZXNzX3Rva2VuX2Zyb250X3N0cjogc3RyaW5nLCBtb2RlX2F1dGhlbnRpZmljYXRpb246IHN0cmluZyxcbiAgICBjYWxsQmFja1N1Y2NlczogKCkgPT4gdm9pZCwgY2FsbEJhY2tFcnJldXI6ICgpID0+IHZvaWQpOiBQcm9taXNlPGFueT4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cbiAgICAgIGNvbnN0IGhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoKTtcbiAgICAgIGhlYWRlcnMuYXBwZW5kKCdDb250ZW50LXR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xuICAgICAgY29uc3Qgb3B0aW9ucyA9IHsgaGVhZGVyczogaGVhZGVycyB9O1xuXG4gICAgICBsZXQgaWRlbnRpZmlhbnRVdGlsaXNhdGV1ciA9ICcnO1xuXG4gICAgICB0cnkge1xuICAgICAgICBpZGVudGlmaWFudFV0aWxpc2F0ZXVyID0gdGhpcy5hY2Nlc3NUb2tlblNlcnZpY2UuZ2V0SWRlbnRpZmlhbnRVdGlsaXNhdGV1cihhY2Nlc3NfdG9rZW5fZnJvbnRfc3RyKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAvLyBUcmFpdGVtZW50IGVuIGNhcyBkJ2VycmV1ciBkZWNvZGFnZSBkdSBqZXRvblxuICAgICAgICBjYWxsQmFja0VycmV1cigpO1xuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgIH1cblxuICAgICAgLy8gVmFsaWRhdGlvbiBkdSBqZXRvbiAtIFLDqWN1cMOpcmF0aW9uIGRlcyBjbMOpc1xuICAgICAgdGhpcy5odHRwLmdldDxhbnk+KHRoaXMuZW52aXJvbm1lbnQucHJpc21lS2V5c0VuZHBvaW50KS5zdWJzY3JpYmUoKGtleXNSZXN1bHQpID0+IHtcblxuICAgICAgICB0aGlzLnBzc1B1YmxpY0tleXMgPSBrZXlzUmVzdWx0LmtleXM7XG5cbiAgICAgICAgLy8gT24gcGV1dCBtYWludGVuYW50IMOpY2hhbmdlciBsZSBqZXRvbiBGUk9OVCBjb250cmUgdW4gamV0b24gQkFDS1xuXG4gICAgICAgIHRoaXMuaHR0cC5wb3N0PGFueT4odGhpcy5lbnZpcm9ubWVudC5wcmlzbWVUb2tlbkVuZHBvaW50LFxuICAgICAgICAgIHRoaXMub2F1dGhTZXJ2aWNlLmF1dGhlbnRpZmljYXRpb25CYWNrQXNzZXJ0aW9uSnd0KGFjY2Vzc190b2tlbl9mcm9udF9zdHIpLCBvcHRpb25zKS5zdWJzY3JpYmUoKGJvZHkpID0+IHtcblxuICAgICAgICAgIC8vIFLDqWN1cMOpcmF0aW9uIGR1IGpldG9uXG4gICAgICAgICAgY29uc3QgYWNjZXNzX3Rva2VuX2JhY2tfc3RyID0gYm9keS5hY2Nlc3NfdG9rZW47XG5cbiAgICAgICAgICAvLyBWYWxpZGF0aW9uXG4gICAgICAgICAgaWYgKCF0aGlzLnZhbGlkYXRlSmV0b24oYWNjZXNzX3Rva2VuX2JhY2tfc3RyLCB0aGlzLnBzc1B1YmxpY0tleXMpKSB7XG4gICAgICAgICAgICBjYWxsQmFja0VycmV1cigpO1xuICAgICAgICAgICAgcmVzb2x2ZSgnZXJyZXVyJyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gTWlzZSDDoCBqb3VyIGRlIGxhIHZhbGV1ciBkJ2V4cGlyYXRpb25cbiAgICAgICAgICBjb25zdCBleHBpcmF0aW9uVGltZSA9IHRoaXMuY2FsY3VsYXRlRXhwaXJhdGlvblRpbWUoYm9keS5leHBpcmVzX2luKTtcblxuICAgICAgICAgIGNvbnN0IHRva2VuRGF0YTogU2Vzc2lvblV0aWxpc2F0ZXVyID0ge1xuICAgICAgICAgICAgYWNjZXNzVG9rZW5CYWNrOiBhY2Nlc3NfdG9rZW5fYmFja19zdHIsXG4gICAgICAgICAgICBhY2Nlc3NUb2tlbkZyb250OiBhY2Nlc3NfdG9rZW5fZnJvbnRfc3RyLFxuICAgICAgICAgICAgb2NlYW5Ub2tlbjogbnVsbCxcbiAgICAgICAgICAgIGV4cGlyYXRpb246IGV4cGlyYXRpb25UaW1lLFxuICAgICAgICAgICAgaW5mb3NVdGlsaXNhdGV1ckZyb250OiBudWxsLFxuICAgICAgICAgICAgaW5mb3NVdGlsaXNhdGV1ckJhY2s6IG51bGwsXG4gICAgICAgICAgICBtb2RlOiBtb2RlX2F1dGhlbnRpZmljYXRpb24sXG4gICAgICAgICAgICBwYXlsb2FkOiBudWxsXG4gICAgICAgICAgfTtcbiAgICAgICAgICB0aGlzLmxvZ2luU2VydmljZS5zdG9yZUluZm9zKHRva2VuRGF0YSk7XG5cbiAgICAgICAgICAvLyBBcHBlbCBkdSBzZXJ2aWNlIHVzZXItaW5mb3MgcG91ciBhdm9pciBsZXMgaW5mb3MgdXRpbGlzYXRldXIgYmFrXG4gICAgICAgICAgdGhpcy51cGRhdGVJbmZvc1V0aWxpc2F0ZXVyKGlkZW50aWZpYW50VXRpbGlzYXRldXIsIGNhbGxCYWNrU3VjY2VzLCBjYWxsQmFja0VycmV1ciwgcmVzb2x2ZSk7XG5cbiAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0VycmV1ciBwZW5kYW50IGxcXCdhdXRoZW50aWZpY2F0aW9uIDogw6ljaGVjIGR1IEpXVCBBc3NlcnRpb24nKTtcbiAgICAgICAgICBpZiAoZXJyLmVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbICcgKyBlcnIuZXJyb3IuZXJyb3JfY29kZSArICcgXSAnICsgZXJyLmVycm9yLmVycm9yX21lc3NhZ2UpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjYWxsQmFja0VycmV1cigpO1xuICAgICAgICAgIHJlc29sdmUoJ2VycmV1cicpO1xuICAgICAgICB9KTtcbiAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgY29uc29sZS5lcnJvcignRXJyZXVyIGxvcnMgZGUgbGEgcsOpY3Vww6lyYXRpb24gZGVzIGNsw6lzIHB1YmxpcXVlcyBQU1MnKTtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICBjYWxsQmFja0VycmV1cigpO1xuICAgICAgICByZXNvbHZlKCdlcnJldXInKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFRyYWl0ZW1lbnQgZHUgamV0b25cbiAgICogQHBhcmFtIG9jZWFuX3Rva2VuX3N0ciBKZXRvblxuICAgKiBAcGFyYW0gY2FsbEJhY2tTdWNjZXMgTcOpdGhvZGUgc2kgdHJhaXRlbWVudCBPS1xuICAgKiBAcGFyYW0gY2FsbEJhY2tFcnJldXIgTcOpdGhvZGUgc2kgdHJhaXRlbWVudCBLT1xuICAgKi9cbiAgaGFuZGxlSmV0b25PY2VhbihvY2Vhbl90b2tlbl9zdHI6IHN0cmluZywgY2FsbEJhY2tTdWNjZXM6ICgpID0+IHZvaWQsIGNhbGxCYWNrRXJyZXVyOiAoKSA9PiB2b2lkKTogUHJvbWlzZTxhbnk+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLyoqIE9uIGwnw6ljaGFuZ2UgY29udHJlIHVuIGpldG9uIGZyb250ICovXG4gICAgICBjb25zdCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKCk7XG4gICAgICBoZWFkZXJzLmFwcGVuZCgnQ29udGVudC10eXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcbiAgICAgIGNvbnN0IG9wdGlvbnMgPSB7IGhlYWRlcnM6IGhlYWRlcnMgfTtcbiAgICAgIHRoaXMuaHR0cC5wb3N0PGFueT4odGhpcy5lbnZpcm9ubWVudC5wcmlzbWVUb2tlbkVuZHBvaW50LFxuICAgICAgICB0aGlzLm9hdXRoU2VydmljZS5hdXRoZW50aWZpY2F0aW9uRnJvbnRBc3NlcnRpb25PY2VhbihvY2Vhbl90b2tlbl9zdHIpLCBvcHRpb25zKS5zdWJzY3JpYmUoKGJvZHlGcm9udCkgPT4ge1xuXG4gICAgICAgIC8vIFLDqWN1cMOpcmF0aW9uIGR1IGpldG9uXG4gICAgICAgIGNvbnN0IGFjY2Vzc190b2tlbl9mcm9udF9zdHIgPSBib2R5RnJvbnQuYWNjZXNzX3Rva2VuO1xuICAgICAgICBjb25zdCBhY2Nlc3NfdG9rZW5fZnJvbnRfZGVjb2RlID0gdGhpcy5hY2Nlc3NUb2tlblNlcnZpY2UuZGVjb2RlQWNjZXNzVG9rZW4oYWNjZXNzX3Rva2VuX2Zyb250X3N0cik7XG5cbiAgICAgICAgLy8gVmFsaWRhdGlvbiBkdSBqZXRvbiAtIFLDqWN1cMOpcmF0aW9uIGRlcyBjbMOpc1xuICAgICAgICB0aGlzLmh0dHAuZ2V0PGFueT4odGhpcy5lbnZpcm9ubWVudC5wcmlzbWVLZXlzRW5kcG9pbnQpLnN1YnNjcmliZSgoa2V5c1Jlc3VsdCkgPT4ge1xuXG4gICAgICAgICAgdGhpcy5wc3NQdWJsaWNLZXlzID0ga2V5c1Jlc3VsdC5rZXlzO1xuXG4gICAgICAgICAgLy8gVmFsaWRhdGlvbiBkdSBqZXRvblxuICAgICAgICAgIGlmICghdGhpcy52YWxpZGF0ZUpldG9uKGFjY2Vzc190b2tlbl9mcm9udF9zdHIsIHRoaXMucHNzUHVibGljS2V5cykpIHtcbiAgICAgICAgICAgIGNhbGxCYWNrRXJyZXVyKCk7XG4gICAgICAgICAgICByZXNvbHZlKCdlcnJldXInKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoIXRoaXMub2F1dGhWYWxpZGF0aW9uU2VydmljZS52YWxpZGVyU3ViT2NlYW4oYWNjZXNzX3Rva2VuX2Zyb250X2RlY29kZSwgdGhpcy5lbnZpcm9ubWVudC5wcmlzbWVDbGllbnRJZCkpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0NvbnRyw7RsZSBkdSBqZXRvbiBkXFwnYWNjw6hzIEZST05UIDogU1VCIG5vbiB2YWxpZGUnKTtcbiAgICAgICAgICAgIGNhbGxCYWNrRXJyZXVyKCk7XG4gICAgICAgICAgICByZXNvbHZlKCdlcnJldXInKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyBPbiBwZXV0IG1haW50ZW5hbnQgw6ljaGFuZ2VyIGxlIGpldG9uIEZST05UIGNvbnRyZSB1biBqZXRvbiBCQUNLXG4gICAgICAgICAgdGhpcy5odHRwLnBvc3Q8YW55Pih0aGlzLmVudmlyb25tZW50LnByaXNtZVRva2VuRW5kcG9pbnQsXG4gICAgICAgICAgICB0aGlzLm9hdXRoU2VydmljZS5hdXRoZW50aWZpY2F0aW9uQmFja0Fzc2VydGlvbkp3dChhY2Nlc3NfdG9rZW5fZnJvbnRfc3RyKSwgb3B0aW9ucykuc3Vic2NyaWJlKChib2R5QmFjaykgPT4ge1xuXG4gICAgICAgICAgICAvLyBSw6ljdXDDqXJhdGlvbiBkdSBqZXRvblxuICAgICAgICAgICAgY29uc3QgYWNjZXNzX3Rva2VuX2JhY2tfc3RyID0gYm9keUJhY2suYWNjZXNzX3Rva2VuO1xuXG4gICAgICAgICAgICAvLyBWYWxpZGF0aW9uIGR1IGpldG9uXG4gICAgICAgICAgICBpZiAoIXRoaXMudmFsaWRhdGVKZXRvbihhY2Nlc3NfdG9rZW5fYmFja19zdHIsIHRoaXMucHNzUHVibGljS2V5cykpIHtcbiAgICAgICAgICAgICAgY2FsbEJhY2tFcnJldXIoKTtcbiAgICAgICAgICAgICAgcmVzb2x2ZSgnZXJyZXVyJyk7XG4gICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gTWlzZSDDoCBqb3VyIGRlIGxhIHZhbGV1ciBkJ2V4cGlyYXRpb25cbiAgICAgICAgICAgIGNvbnN0IGV4cGlyYXRpb25UaW1lID0gdGhpcy5jYWxjdWxhdGVFeHBpcmF0aW9uVGltZShib2R5QmFjay5leHBpcmVzX2luKTtcblxuICAgICAgICAgICAgLy8gTG9naW5cbiAgICAgICAgICAgIGNvbnN0IHRva2VuRGF0YTogU2Vzc2lvblV0aWxpc2F0ZXVyID0ge1xuICAgICAgICAgICAgICBhY2Nlc3NUb2tlbkJhY2s6IGFjY2Vzc190b2tlbl9iYWNrX3N0cixcbiAgICAgICAgICAgICAgYWNjZXNzVG9rZW5Gcm9udDogYWNjZXNzX3Rva2VuX2Zyb250X3N0cixcbiAgICAgICAgICAgICAgb2NlYW5Ub2tlbjogb2NlYW5fdG9rZW5fc3RyLFxuICAgICAgICAgICAgICBleHBpcmF0aW9uOiBleHBpcmF0aW9uVGltZSxcbiAgICAgICAgICAgICAgaW5mb3NVdGlsaXNhdGV1ckZyb250OiBudWxsLFxuICAgICAgICAgICAgICBpbmZvc1V0aWxpc2F0ZXVyQmFjazogbnVsbCxcbiAgICAgICAgICAgICAgbW9kZTogJ29jZWFuJyxcbiAgICAgICAgICAgICAgcGF5bG9hZCA6IG51bGxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHRoaXMubG9naW5TZXJ2aWNlLnN0b3JlSW5mb3ModG9rZW5EYXRhKTtcblxuICAgICAgICAgICAgLy8gQXBwZWwgZHUgc2VydmljZSB1c2VyLWluZm9zIHBvdXIgYXZvaXIgbGVzIGluZm9zIHV0aWxpc2F0ZXVyXG4gICAgICAgICAgICBjb25zdCBpZGVudGlmaWFudFV0aWxpc2F0ZXVyID0gdGhpcy5hY2Nlc3NUb2tlblNlcnZpY2UuZ2V0SWRlbnRpZmlhbnRVdGlsaXNhdGV1cihhY2Nlc3NfdG9rZW5fZnJvbnRfc3RyKTtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlSW5mb3NVdGlsaXNhdGV1cihpZGVudGlmaWFudFV0aWxpc2F0ZXVyLCBjYWxsQmFja1N1Y2NlcywgY2FsbEJhY2tFcnJldXIsIHJlc29sdmUpO1xuXG4gICAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyZXVyIHBlbmRhbnQgbFxcJ2F1dGhlbnRpZmljYXRpb24gOiDDqWNoZWMgZHUgSldUIEFzc2VydGlvbicpO1xuICAgICAgICAgICAgaWYgKGVyci5lcnJvcl9tZXNzYWdlKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1sgJyArIGVyci5lcnJvcl9jb2RlICsgJyBdICcgKyBlcnIuZXJyb3JfbWVzc2FnZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYWxsQmFja0VycmV1cigpO1xuICAgICAgICAgICAgcmVzb2x2ZSgnZXJyZXVyJyk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJldXIgbG9ycyBkZSBsYSByw6ljdXDDqXJhdGlvbiBkZXMgY2zDqXMgcHVibGlxdWVzIFBTUycpO1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICAgICAgICBjYWxsQmFja0VycmV1cigpO1xuICAgICAgICAgIHJlc29sdmUoJ2VycmV1cicpO1xuICAgICAgICB9KTtcbiAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgY29uc29sZS5lcnJvcignRXJyZXVyIEhUVFAnKTtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICBjYWxsQmFja0VycmV1cigpO1xuICAgICAgICByZXNvbHZlKCdlcnJldXInKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIE3DqXRob2RlIGRlIHJlbm92ZWxsZW1lbnQgZCd1biBqZXRvblxuICAgKiBAcGFyYW0gYWNjZXNzX3Rva2VuX2Zyb250X3N0ciBsZSBqZXRvbiDDoCByZW5vdXZlbGxlclxuICAgKi9cbiAgcHVibGljIHJlbmV3QWNjZXNzVG9rZW5Qb3J0YWlsKGFjY2Vzc190b2tlbl9mcm9udF9zdHI6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGlmICh0aGlzLnBzc1B1YmxpY0tleXMpIHtcbiAgICAgICAgdGhpcy5yZW5ld0FjY2Vzc1Rva2VuKGFjY2Vzc190b2tlbl9mcm9udF9zdHIsIHRoaXMucHNzUHVibGljS2V5cywgcmVzb2x2ZSwgcmVqZWN0KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIFLDqWN1cMOpcmF0aW9uIGRlcyBjbMOpcyBwb3VyIHZhbGlkZXIgbGUgamV0b25cbiAgICAgICAgdGhpcy5odHRwLmdldDxhbnk+KHRoaXMuZW52aXJvbm1lbnQucHJpc21lS2V5c0VuZHBvaW50KS5zdWJzY3JpYmUoKGtleXNSZXN1bHQpID0+IHtcblxuICAgICAgICAgIHRoaXMucHNzUHVibGljS2V5cyA9IGtleXNSZXN1bHQua2V5cztcbiAgICAgICAgICB0aGlzLnJlbmV3QWNjZXNzVG9rZW4oYWNjZXNzX3Rva2VuX2Zyb250X3N0ciwgdGhpcy5wc3NQdWJsaWNLZXlzLCByZXNvbHZlLCByZWplY3QpO1xuXG4gICAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJldXIgbG9ycyBkZSBsYSByw6ljdXDDqXJhdGlvbiBkZXMgY2zDqXMgcHVibGlxdWVzIFBTUycpO1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcblxuICAgICAgICAgIC8vIFJlamV0IGRlIGxhIHByb21pc2UgcG91ciBzdG9wcGVyIGxlIHJhZnJhaWNoaXNzZW1lbnQgY2FyIG9uIGEgdW5lIGVycmV1clxuICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNw6l0aG9kZSBkZSByZW5vdmVsbGVtZW50IGQndW4gamV0b25cbiAgICogQHBhcmFtIGFjY2Vzc190b2tlbl9mcm9udF9zdHIgIGxlIGpldG9uIMOgIHJlbm91dmVsbGVyXG4gICAqIEBwYXJhbSBwdWJsaWNLZXlzIGxlcyBjbMOpcyBwb3VyIHZhbGlkZXIgbGUgamV0b25cbiAgICogQHBhcmFtIHJlc29sdmUgbcOpdGhvZGUgcG91ciBpbmRpcXVlciBxdWUgbGUgcmVub3V2ZWxsZW1lbnQgZXN0IHRlcm1pbsOpXG4gICAqIEBwYXJhbSByZWplY3QgbcOpdGhvZGUgcG91ciBpbmRpcXVlciBxdSd1bmUgZXJyZXVyIGVzdCBzdXJ2ZW51ZSBsb3JzIGR1IHJlbm91dmVsbGVtZW50XG4gICAqL1xuICBwcml2YXRlIHJlbmV3QWNjZXNzVG9rZW4oYWNjZXNzX3Rva2VuX2Zyb250X3N0cjogc3RyaW5nLCBwdWJsaWNLZXlzOiBhbnksIHJlc29sdmU6IGFueSwgcmVqZWN0OiBhbnkpIHtcbiAgICAvLyBPbiBwZXV0IG1haW50ZW5hbnQgw6ljaGFuZ2VyIGxlIGpldG9uIEZST05UIGNvbnRyZSB1biBqZXRvbiBCQUNLXG4gICAgY29uc3QgaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycygpO1xuICAgIGhlYWRlcnMuYXBwZW5kKCdDb250ZW50LXR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7IGhlYWRlcnM6IGhlYWRlcnMgfTtcblxuICAgIHRoaXMuaHR0cC5wb3N0PGFueT4odGhpcy5lbnZpcm9ubWVudC5wcmlzbWVUb2tlbkVuZHBvaW50LFxuICAgICAgdGhpcy5vYXV0aFNlcnZpY2UuYXV0aGVudGlmaWNhdGlvbkJhY2tBc3NlcnRpb25Kd3QoYWNjZXNzX3Rva2VuX2Zyb250X3N0ciksIG9wdGlvbnMpLnN1YnNjcmliZSgoYm9keSkgPT4ge1xuXG4gICAgICAvLyBSw6ljdXDDqXJhdGlvbiBkdSBqZXRvblxuICAgICAgY29uc3QgYWNjZXNzX3Rva2VuX2JhY2tfc3RyID0gYm9keS5hY2Nlc3NfdG9rZW47XG5cbiAgICAgIC8vIFZhbGlkYXRpb25cbiAgICAgIGlmICghdGhpcy52YWxpZGF0ZUpldG9uKGFjY2Vzc190b2tlbl9iYWNrX3N0ciwgcHVibGljS2V5cykpIHtcbiAgICAgICAgcmVqZWN0KCdqZXRvbiBpbnZhbGlkZScpO1xuICAgICAgfVxuXG4gICAgICAvLyBNaXNlIMOgIGpvdXIgZGUgbGEgdmFsZXVyIGQnZXhwaXJhdGlvblxuICAgICAgY29uc3QgZXhwaXJhdGlvblRpbWUgPSB0aGlzLmNhbGN1bGF0ZUV4cGlyYXRpb25UaW1lKGJvZHkuZXhwaXJlc19pbik7XG4gICAgICB0aGlzLmxvZ2luU2VydmljZS51cGRhdGVBY2Nlc3NUb2tlbihhY2Nlc3NfdG9rZW5fYmFja19zdHIsIGV4cGlyYXRpb25UaW1lKTtcblxuICAgICAgLy8gUmVzb2x2ZSBkZSBsYSBwcm9taXNlIHBvdXIgaW5kaXF1ZXIgcXVlIGxlIHJlZnJlc2ggZXN0IG9rXG4gICAgICByZXNvbHZlKHRydWUpO1xuICAgIH0sIChlcnIpID0+IHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0VycmV1ciBwZW5kYW50IGxcXCdhdXRoZW50aWZpY2F0aW9uIDogw6ljaGVjIGR1IEpXVCBBc3NlcnRpb24nKTtcbiAgICAgIGlmIChlcnIuZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignWyAnICsgZXJyLmVycm9yLmVycm9yX2NvZGUgKyAnIF0gJyArIGVyci5lcnJvci5lcnJvcl9tZXNzYWdlKTtcbiAgICAgIH1cblxuICAgICAgLy8gUmVqZXQgZGUgbGEgcHJvbWlzZSBwb3VyIHN0b3BwZXIgbGUgcmFmcmFpY2hpc3NlbWVudCBjYXIgb24gYSB1bmUgZXJyZXVyXG4gICAgICByZWplY3QoZXJyKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0aW9uIGR1IGpldG9uIDogdm9pciBsYSBkb2N1bWVudGF0aW9uIEpXVCBBc3NlcnRpb25cbiAgICogQHBhcmFtIGFjY2Vzc190b2tlbl9iYWNrX3N0ciBsZSBqZXRvblxuICAgKiBAcGFyYW0gYWNjZXNzX3Rva2VuX2JhY2tfZGVjb2RlIGxlIGpldG9uIGTDqWNvZMOpXG4gICAqIEBwYXJhbSBwdWJsaWNLZXlzIGxlcyBjbMOpc1xuICAgKi9cbiAgcHJpdmF0ZSB2YWxpZGF0ZUpldG9uKGFjY2Vzc190b2tlbl9iYWNrX3N0cjogc3RyaW5nLCBwdWJsaWNLZXlzOiBzdHJpbmcpOiBib29sZWFuIHtcblxuICAgIGNvbnN0IGFjY2Vzc190b2tlbl9iYWNrX2RlY29kZSA9IHRoaXMuYWNjZXNzVG9rZW5TZXJ2aWNlLmRlY29kZUFjY2Vzc1Rva2VuKGFjY2Vzc190b2tlbl9iYWNrX3N0cik7XG5cbiAgICAvLyBWYWxpZGF0aW9uIGR1IGpldG9uIDogdm9pciBsYSBkb2N1bWVudGF0aW9uIEpXVCBBc3NlcnRpb25cbiAgICBpZiAoIXRoaXMub2F1dGhWYWxpZGF0aW9uU2VydmljZS52YWxpZGVySXNzKGFjY2Vzc190b2tlbl9iYWNrX2RlY29kZSkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0NvbnRyw7RsZSBkdSBqZXRvbiBkXFwnYWNjw6hzIDogSVNTIG5vbiB2YWxpZGUnKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMub2F1dGhWYWxpZGF0aW9uU2VydmljZS52YWxpZGVyRXhwKGFjY2Vzc190b2tlbl9iYWNrX2RlY29kZSkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0NvbnRyw7RsZSBkdSBqZXRvbiBkXFwnYWNjw6hzIDogRVhQIG5vbiB2YWxpZGUnKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMub2F1dGhWYWxpZGF0aW9uU2VydmljZS52YWxpZGVyQXVkTm9uVmlkZShhY2Nlc3NfdG9rZW5fYmFja19kZWNvZGUpKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdDb250csO0bGUgZHUgamV0b24gZFxcJ2FjY8OocyA6IEFVRCBub24gdmFsaWRlJyk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLm9hdXRoVmFsaWRhdGlvblNlcnZpY2UudmFsaWRlclNpZ25hdHVyZShhY2Nlc3NfdG9rZW5fYmFja19zdHIsIHB1YmxpY0tleXMsIEFMR09fVkFMSURBVElPTikpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0NvbnRyw7RsZSBkdSBqZXRvbiBkXFwnYWNjw6hzIDogU2lnbmF0dXJlIG5vbiB2YWxpZGUnKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBjYWxjdWxlIGxhIGRhdGUgZCdleHBpcmF0aW9uIGR1IGpldG9uXG4gICAqIEBwYXJhbSBleHBpcmVzSW5OdW0gbGEgZHVyw6llIGRlIHZhbGlkaXTDqSBkdSBqZXRvblxuICAgKi9cbiAgcHJpdmF0ZSBjYWxjdWxhdGVFeHBpcmF0aW9uVGltZShleHBpcmVzSW5OdW06IGFueSk6IERhdGUge1xuICAgIGNvbnN0IGV4cGlyYXRpb25EYXRlID0gbmV3IERhdGUoKTtcbiAgICBleHBpcmF0aW9uRGF0ZS5zZXRTZWNvbmRzKGV4cGlyYXRpb25EYXRlLmdldFNlY29uZHMoKSArIGV4cGlyZXNJbk51bSk7XG4gICAgcmV0dXJuIGV4cGlyYXRpb25EYXRlO1xuICB9XG5cbiAgLyoqXG4gICAqIE1ldCDDoCBqb3VyIGxlcyBkb25uw6llcyB1dGlsaXNhdGV1ciBlbiB1dGlsaXNhdGV1ciBsZSBzZXJ2aWNlIHVzZXItaW5mb3NcbiAgICogQHBhcmFtIGlkZW50aWZpYW50VXRpbGlzYXRldXIgbGUgdXNlclxuICAgKiBAcGFyYW0gY2FsbEJhY2tTdWNjZXMgbGUgY2FsbGJhY2sgc2kgdG91dCBlc3Qgb2tcbiAgICogQHBhcmFtIGNhbGxCYWNrRXJyZXVyIGxlIGNhbGxiYWNrIGQnZXJyZXVyXG4gICAqIEBwYXJhbSByZXNvbHZlIHByb3ZpZW50IGRlIGxhIHByb21pc2UgcmV0b3VybsOpZSBwYXIgY2Ugc2VydmljZSBPYXV0aENhbGxiYWNrU2VydmljZVxuICAgKi9cbiAgcHJpdmF0ZSB1cGRhdGVJbmZvc1V0aWxpc2F0ZXVyKGlkZW50aWZpYW50VXRpbGlzYXRldXI6IHN0cmluZywgY2FsbEJhY2tTdWNjZXM6ICgpID0+IHZvaWQsIGNhbGxCYWNrRXJyZXVyOiAoKSA9PiB2b2lkLCByZXNvbHZlOiBhbnkpIHtcbiAgICBpZiAodGhpcy5lbnZpcm9ubWVudC5jaGFyZ2VyVXNlckluZm9zQmFjaykge1xuICAgICAgdGhpcy5nZXRVc2VySW5mb09ic2VydmFibGUoaWRlbnRpZmlhbnRVdGlsaXNhdGV1ciwgdGhpcy5sb2dpblNlcnZpY2UuZ2V0QWNjZXNzVG9rZW5CYWNrKCkpLnN1YnNjcmliZShcbiAgICAgICAgYm9keVVzZXIgPT4ge1xuXG4gICAgICAgICAgdGhpcy5sb2dpblNlcnZpY2UudXBkYXRlSW5mb3NVdGlsaXNhdGV1ckJhY2soYm9keVVzZXIpO1xuXG4gICAgICAgICAgaWYgKHRoaXMuZW52aXJvbm1lbnQuY2hhcmdlclVzZXJJbmZvc0Zyb250KSB7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUluZm9zVXRpbGlzYXRldXJGcm9udChpZGVudGlmaWFudFV0aWxpc2F0ZXVyLCBjYWxsQmFja1N1Y2NlcywgY2FsbEJhY2tFcnJldXIsIHJlc29sdmUpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjYWxsQmFja1N1Y2NlcygpO1xuICAgICAgICAgICAgcmVzb2x2ZSgnc3VjZXNzJyk7XG4gICAgICAgICAgfVxuXG4gICAgICAgIH0sIGVyciA9PiB0aGlzLmhhbmRsZXJVc2VySW5mb0Vycm9yKGVyciwgY2FsbEJhY2tFcnJldXIsIHJlc29sdmUpXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAodGhpcy5lbnZpcm9ubWVudC5jaGFyZ2VyVXNlckluZm9zRnJvbnQpIHtcbiAgICAgIHRoaXMudXBkYXRlSW5mb3NVdGlsaXNhdGV1ckZyb250KGlkZW50aWZpYW50VXRpbGlzYXRldXIsIGNhbGxCYWNrU3VjY2VzLCBjYWxsQmFja0VycmV1ciwgcmVzb2x2ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNhbGxCYWNrU3VjY2VzKCk7XG4gICAgICByZXNvbHZlKCdzdWNlc3MnKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUGVybWV0IGRlIHLDqWFsaXNlciB1biBhcHBlbCDDoCB1c2VyLWluZm8gYXZlYyB1dW4gYWNjZXNzIHRva2VuIGZyb250IGV0IGRlIG1ldHRyZSDDoCBqb3VyIGxlcyBpbmZvcm1hdGlvbnMgdXRpbGlzYXRldXJcbiAgICogQHBhcmFtIGlkZW50aWZpYW50VXRpbGlzYXRldXIgbGUgdXNlclxuICAgKiBAcGFyYW0gY2FsbEJhY2tTdWNjZXMgbGUgY2FsbGJhY2sgc2kgdG91dCBlc3Qgb2tcbiAgICogQHBhcmFtIGNhbGxCYWNrRXJyZXVyIGxlIGNhbGxiYWNrIGQnZXJyZXVyXG4gICAqIEBwYXJhbSByZXNvbHZlIHByb3ZpZW50IGRlIGxhIHByb21pc2UgcmV0b3VybsOpZSBwYXIgY2Ugc2VydmljZSBPYXV0aENhbGxiYWNrU2VydmljZVxuICAgKi9cbiAgcHJpdmF0ZSB1cGRhdGVJbmZvc1V0aWxpc2F0ZXVyRnJvbnQoaWRlbnRpZmlhbnRVdGlsaXNhdGV1cjogc3RyaW5nLFxuICAgIGNhbGxCYWNrU3VjY2VzOiAoKSA9PiB2b2lkLCBjYWxsQmFja0VycmV1cjogKCkgPT4gdm9pZCwgcmVzb2x2ZTogYW55KSB7XG4gICAgdGhpcy5nZXRVc2VySW5mb09ic2VydmFibGUoaWRlbnRpZmlhbnRVdGlsaXNhdGV1ciwgdGhpcy5sb2dpblNlcnZpY2UuZ2V0QWNjZXNzVG9rZW5Gcm9udCgpKS5zdWJzY3JpYmUocmVzdWx0ID0+IHtcbiAgICAgIHRoaXMubG9naW5TZXJ2aWNlLnVwZGF0ZUluZm9zVXRpbGlzYXRldXJGcm9udChyZXN1bHQpO1xuICAgICAgY2FsbEJhY2tTdWNjZXMoKTtcbiAgICAgIHJlc29sdmUoJ3N1Y2VzcycpO1xuICAgIH0sXG4gICAgZXJyID0+IHRoaXMuaGFuZGxlclVzZXJJbmZvRXJyb3IoZXJyLCBjYWxsQmFja0VycmV1ciwgcmVzb2x2ZSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcm1ldCBkZSByw6lhbGlzZXIgbCdhcHBlbCBhdSBzZXJ2aWNlIHVzZXItaWZub3NcbiAgICogQHBhcmFtIGlkZW50aWZpYW50VXRpbGlzYXRldXIgbGUgdXNlclxuICAgKiBAcGFyYW0gdG9rZW4gbGUgdG9rZW4gZCdhdXRoZW50aWZpY2F0aW9uXG4gICAqL1xuICBwcml2YXRlIGdldFVzZXJJbmZvT2JzZXJ2YWJsZShpZGVudGlmaWFudFV0aWxpc2F0ZXVyOiBzdHJpbmcsIHRva2VuOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IHJlcXVlc3RIZWFkZXJzID0ge1xuICAgICAgaGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKHtcbiAgICAgICAgJ0NvbnRlbnQtdHlwZScgOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICdBdXRob3JpemF0aW9uJyA6ICdCZWFyZXIgJyArIHRva2VuXG4gICAgICB9KVxuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5odHRwLnBvc3Q8YW55Pih0aGlzLmVudmlyb25tZW50LnByaXNtZVVzZXJFbmRwb2ludCxcbiAgICAgIHsndXNlcm5hbWUnOiBpZGVudGlmaWFudFV0aWxpc2F0ZXVyfSwgcmVxdWVzdEhlYWRlcnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcm1ldCBkZSBnw6lyZXIgbGVzIG1lc3NhZ2VzIGQnZXJyZXVycyBkdSBzZXJ2aWNlIHVzZXItaW5mb3NcbiAgICogQHBhcmFtIGVyciBsZSBtZXNzYWdlIGRlIHJldG91ciBkdSBzZXJ2aWNlXG4gICAqIEBwYXJhbSBjYWxsQmFja0VycmV1ciBsZSBjYWxsYmFjayBkJ2VycmV1clxuICAgKiBAcGFyYW0gcmVzb2x2ZSBwcm92aWVudCBkZSBsYSBwcm9taXNlIHJldG91cm7DqWUgcGFyIGNlIHNlcnZpY2UgT2F1dGhDYWxsYmFja1NlcnZpY2VcbiAgICovXG4gIHByaXZhdGUgaGFuZGxlclVzZXJJbmZvRXJyb3IoZXJyOiBhbnksIGNhbGxCYWNrRXJyZXVyOiAoKSA9PiB2b2lkLCByZXNvbHZlOiBhbnkpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJldXIgcGVuZGFudCBsXFwnYXV0aGVudGlmaWNhdGlvbiA6IMOpY2hlYyBkdSB1c2VyLWluZm8nKTtcbiAgICBpZiAoZXJyLmVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdbICcgKyBlcnIuZXJyb3IuZXJyb3JfY29kZSArICcgXSAnICsgZXJyLmVycm9yLmVycm9yX21lc3NhZ2UpO1xuICAgIH1cbiAgICBjYWxsQmFja0VycmV1cigpO1xuICAgIHJlc29sdmUoJ2VycmV1cicpO1xuICB9XG5cbn1cbiJdfQ==