import { Inject, Injectable } from '@angular/core';
import { Subject, timer } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { PrismeAngularConfiguration } from '../prisme-angular.config';
import * as i0 from "@angular/core";
import * as i1 from "./oauth-callback.service";
import * as i2 from "./login.service";
import * as i3 from "../prisme-angular-init.config";
import * as i4 from "../prisme-angular.config";
export class RefreshService {
    constructor(environment, oauthCallbackService, loginService, prismeAngularInitConfig) {
        this.environment = environment;
        this.oauthCallbackService = oauthCallbackService;
        this.loginService = loginService;
        this.prismeAngularInitConfig = prismeAngularInitConfig;
        this.timerSubject = new Subject();
    }
    initierRafraichissement() {
        // on s'assure que le rafraichissement ne se lance pas plusieurs fois
        this.stopperRafraichissement();
        sessionStorage.setItem(this.prismeAngularInitConfig.cleStockageEtatRafraichissement, 'O');
        this.lancerTimerRafraichissement();
    }
    /**
     * Permet de relancer rafraichissement
     * Ex : lors d'un F5 sur la page le timer est détruit
     */
    relancerRafraichissement() {
        const etatRafraichissement = sessionStorage.getItem(this.prismeAngularInitConfig.cleStockageEtatRafraichissement);
        if (etatRafraichissement === 'O' && !this.timerSubscription) {
            this.lancerTimerRafraichissement();
        }
    }
    /**
     * Création du timer qui va rafraichir le jeton au bout d'un temps donné
     */
    lancerTimerRafraichissement() {
        this.timerSubscription = timer(this.environment.prismeRefreshTokensInterval, this.environment.prismeRefreshTokensInterval)
            .pipe(takeUntil(this.timerSubject))
            .subscribe(() => {
            this.rafraichir();
        });
    }
    /**
     * Rafraichissement effectif du jeton selon le mode de connexion.
     * En cas d'erreur on arrête le service
     */
    rafraichir() {
        if (sessionStorage.getItem(this.prismeAngularInitConfig.cleStockageEtatRafraichissement) === 'O') {
            const accessToken = this.loginService.getAccessTokenBack();
            if (accessToken !== null) {
                this.oauthCallbackService.renewAccessTokenPortail(accessToken).catch(error => {
                    console.error('error refresh jeton : ' + JSON.stringify(error));
                    this.stopperRafraichissement();
                });
            }
        }
    }
    /**
     * Permet de stopper le rafraichissement du jeton
     * @returns Promise<any> renvoi resolve(true) lorsque le service est arreté
     */
    stopperRafraichissement() {
        return new Promise((resolve, reject) => {
            sessionStorage.setItem(this.prismeAngularInitConfig.cleStockageEtatRafraichissement, 'N');
            // arrêt du timer
            this.timerSubject.next();
            if (this.timerSubscription) {
                this.timerSubscription.unsubscribe();
            }
            resolve(true);
        });
    }
    /**
     * Permet de stopper le rafraichissement du jeton et de se deconnecter
     * Cette méthode contient les appels à
     *  RefreshService.stopperRafraichissement() et LoginService.deconnecter()
     * @returns Promise<any> renvoi resolve(true) lorsque les opérations sont terminées
     */
    stopperRafraichissementEtDeconnecter() {
        return new Promise((resolve, reject) => {
            this.stopperRafraichissement().then(() => {
                this.loginService.deconnecter().then(() => {
                    resolve(true);
                });
            });
        });
    }
}
RefreshService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.1.0", ngImport: i0, type: RefreshService, deps: [{ token: PrismeAngularConfiguration }, { token: i1.OauthCallbackService }, { token: i2.LoginService }, { token: i3.PrismeAngularInitConfig }], target: i0.ɵɵFactoryTarget.Injectable });
RefreshService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.1.0", ngImport: i0, type: RefreshService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.1.0", ngImport: i0, type: RefreshService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i4.PrismeAngularConfiguration, decorators: [{
                    type: Inject,
                    args: [PrismeAngularConfiguration]
                }] }, { type: i1.OauthCallbackService }, { type: i2.LoginService }, { type: i3.PrismeAngularInitConfig }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVmcmVzaC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYWNvc3MvcHJpc21lLWFuZ3VsYXItaW50cmFuZXQvc3JjL2xpYi9zZXJ2aWNlL3JlZnJlc2guc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsT0FBTyxFQUFnQixLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDcEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBSTNDLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLDBCQUEwQixDQUFDOzs7Ozs7QUFLdEUsTUFBTSxPQUFPLGNBQWM7SUFLekIsWUFBd0QsV0FBdUMsRUFDM0Usb0JBQTBDLEVBQzFDLFlBQTBCLEVBQzFCLHVCQUFnRDtRQUhaLGdCQUFXLEdBQVgsV0FBVyxDQUE0QjtRQUMzRSx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBQzFDLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLDRCQUF1QixHQUF2Qix1QkFBdUIsQ0FBeUI7UUFMNUQsaUJBQVksR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO0lBTXJDLENBQUM7SUFFTSx1QkFBdUI7UUFDNUIscUVBQXFFO1FBQ3JFLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO1FBQy9CLGNBQWMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLCtCQUErQixFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzFGLElBQUksQ0FBQywyQkFBMkIsRUFBRSxDQUFDO0lBQ3JDLENBQUM7SUFFRDs7O09BR0c7SUFDSSx3QkFBd0I7UUFDN0IsTUFBTSxvQkFBb0IsR0FBRyxjQUFjLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO1FBQ2xILElBQUksb0JBQW9CLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFO1lBQzNELElBQUksQ0FBQywyQkFBMkIsRUFBRSxDQUFDO1NBQ3BDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0ssMkJBQTJCO1FBQ2pDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQywyQkFBMkIsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLDJCQUEyQixDQUFDO2FBQ3ZILElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO2FBQ2xDLFNBQVMsQ0FBQyxHQUFHLEVBQUU7WUFDZCxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDcEIsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ssVUFBVTtRQUNoQixJQUFJLGNBQWMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLCtCQUErQixDQUFDLEtBQUssR0FBRyxFQUFFO1lBQ2hHLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztZQUMzRCxJQUFJLFdBQVcsS0FBSyxJQUFJLEVBQUU7Z0JBQ3hCLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyx1QkFBdUIsQ0FBQyxXQUFXLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUU7b0JBQzNFLE9BQU8sQ0FBQyxLQUFLLENBQUMsd0JBQXdCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO29CQUNoRSxJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztnQkFDakMsQ0FBQyxDQUFDLENBQUM7YUFDSjtTQUNGO0lBQ0gsQ0FBQztJQUVEOzs7T0FHRztJQUNJLHVCQUF1QjtRQUM1QixPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3JDLGNBQWMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLCtCQUErQixFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQzFGLGlCQUFpQjtZQUNqQixJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ3pCLElBQUksSUFBSSxDQUFDLGlCQUFpQixFQUFFO2dCQUMxQixJQUFJLENBQUMsaUJBQWlCLENBQUMsV0FBVyxFQUFFLENBQUM7YUFDdEM7WUFDRCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDaEIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSSxvQ0FBb0M7UUFDekMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNyQyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO2dCQUN2QyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7b0JBQ3hDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDaEIsQ0FBQyxDQUFDLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQzs7MkdBdEZVLGNBQWMsa0JBS0wsMEJBQTBCOytHQUxuQyxjQUFjLGNBRmIsTUFBTTsyRkFFUCxjQUFjO2tCQUgxQixVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQjs7MEJBTWMsTUFBTTsyQkFBQywwQkFBMEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN1YmplY3QsIFN1YnNjcmlwdGlvbiwgdGltZXIgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IExvZ2luU2VydmljZSB9IGZyb20gJy4vbG9naW4uc2VydmljZSc7XG5pbXBvcnQgeyBPYXV0aENhbGxiYWNrU2VydmljZSB9IGZyb20gJy4vb2F1dGgtY2FsbGJhY2suc2VydmljZSc7XG5pbXBvcnQgeyBQcmlzbWVBbmd1bGFySW5pdENvbmZpZyB9IGZyb20gJy4uL3ByaXNtZS1hbmd1bGFyLWluaXQuY29uZmlnJztcbmltcG9ydCB7IFByaXNtZUFuZ3VsYXJDb25maWd1cmF0aW9uIH0gZnJvbSAnLi4vcHJpc21lLWFuZ3VsYXIuY29uZmlnJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgUmVmcmVzaFNlcnZpY2Uge1xuXG4gIHByaXZhdGUgdGltZXJTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSB0aW1lclN1YmplY3QgPSBuZXcgU3ViamVjdCgpO1xuXG4gIGNvbnN0cnVjdG9yKEBJbmplY3QoUHJpc21lQW5ndWxhckNvbmZpZ3VyYXRpb24pIHByaXZhdGUgZW52aXJvbm1lbnQ6IFByaXNtZUFuZ3VsYXJDb25maWd1cmF0aW9uLFxuICAgICAgICAgICAgICBwcml2YXRlIG9hdXRoQ2FsbGJhY2tTZXJ2aWNlOiBPYXV0aENhbGxiYWNrU2VydmljZSxcbiAgICAgICAgICAgICAgcHJpdmF0ZSBsb2dpblNlcnZpY2U6IExvZ2luU2VydmljZSxcbiAgICAgICAgICAgICAgcHJpdmF0ZSBwcmlzbWVBbmd1bGFySW5pdENvbmZpZzogUHJpc21lQW5ndWxhckluaXRDb25maWcpIHtcbiAgfVxuXG4gIHB1YmxpYyBpbml0aWVyUmFmcmFpY2hpc3NlbWVudCgpIHtcbiAgICAvLyBvbiBzJ2Fzc3VyZSBxdWUgbGUgcmFmcmFpY2hpc3NlbWVudCBuZSBzZSBsYW5jZSBwYXMgcGx1c2lldXJzIGZvaXNcbiAgICB0aGlzLnN0b3BwZXJSYWZyYWljaGlzc2VtZW50KCk7XG4gICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSh0aGlzLnByaXNtZUFuZ3VsYXJJbml0Q29uZmlnLmNsZVN0b2NrYWdlRXRhdFJhZnJhaWNoaXNzZW1lbnQsICdPJyk7XG4gICAgdGhpcy5sYW5jZXJUaW1lclJhZnJhaWNoaXNzZW1lbnQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQZXJtZXQgZGUgcmVsYW5jZXIgcmFmcmFpY2hpc3NlbWVudFxuICAgKiBFeCA6IGxvcnMgZCd1biBGNSBzdXIgbGEgcGFnZSBsZSB0aW1lciBlc3QgZMOpdHJ1aXRcbiAgICovXG4gIHB1YmxpYyByZWxhbmNlclJhZnJhaWNoaXNzZW1lbnQoKSB7XG4gICAgY29uc3QgZXRhdFJhZnJhaWNoaXNzZW1lbnQgPSBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKHRoaXMucHJpc21lQW5ndWxhckluaXRDb25maWcuY2xlU3RvY2thZ2VFdGF0UmFmcmFpY2hpc3NlbWVudCk7XG4gICAgaWYgKGV0YXRSYWZyYWljaGlzc2VtZW50ID09PSAnTycgJiYgIXRoaXMudGltZXJTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMubGFuY2VyVGltZXJSYWZyYWljaGlzc2VtZW50KCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENyw6lhdGlvbiBkdSB0aW1lciBxdWkgdmEgcmFmcmFpY2hpciBsZSBqZXRvbiBhdSBib3V0IGQndW4gdGVtcHMgZG9ubsOpXG4gICAqL1xuICBwcml2YXRlIGxhbmNlclRpbWVyUmFmcmFpY2hpc3NlbWVudCgpIHtcbiAgICB0aGlzLnRpbWVyU3Vic2NyaXB0aW9uID0gdGltZXIodGhpcy5lbnZpcm9ubWVudC5wcmlzbWVSZWZyZXNoVG9rZW5zSW50ZXJ2YWwsIHRoaXMuZW52aXJvbm1lbnQucHJpc21lUmVmcmVzaFRva2Vuc0ludGVydmFsKVxuICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMudGltZXJTdWJqZWN0KSlcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICB0aGlzLnJhZnJhaWNoaXIoKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJhZnJhaWNoaXNzZW1lbnQgZWZmZWN0aWYgZHUgamV0b24gc2Vsb24gbGUgbW9kZSBkZSBjb25uZXhpb24uXG4gICAqIEVuIGNhcyBkJ2VycmV1ciBvbiBhcnLDqnRlIGxlIHNlcnZpY2VcbiAgICovXG4gIHByaXZhdGUgcmFmcmFpY2hpcigpIHtcbiAgICBpZiAoc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSh0aGlzLnByaXNtZUFuZ3VsYXJJbml0Q29uZmlnLmNsZVN0b2NrYWdlRXRhdFJhZnJhaWNoaXNzZW1lbnQpID09PSAnTycpIHtcbiAgICAgIGNvbnN0IGFjY2Vzc1Rva2VuID0gdGhpcy5sb2dpblNlcnZpY2UuZ2V0QWNjZXNzVG9rZW5CYWNrKCk7XG4gICAgICBpZiAoYWNjZXNzVG9rZW4gIT09IG51bGwpIHtcbiAgICAgICAgdGhpcy5vYXV0aENhbGxiYWNrU2VydmljZS5yZW5ld0FjY2Vzc1Rva2VuUG9ydGFpbChhY2Nlc3NUb2tlbikuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ2Vycm9yIHJlZnJlc2ggamV0b24gOiAnICsgSlNPTi5zdHJpbmdpZnkoZXJyb3IpKTtcbiAgICAgICAgICB0aGlzLnN0b3BwZXJSYWZyYWljaGlzc2VtZW50KCk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBQZXJtZXQgZGUgc3RvcHBlciBsZSByYWZyYWljaGlzc2VtZW50IGR1IGpldG9uXG4gICAqIEByZXR1cm5zIFByb21pc2U8YW55PiByZW52b2kgcmVzb2x2ZSh0cnVlKSBsb3JzcXVlIGxlIHNlcnZpY2UgZXN0IGFycmV0w6lcbiAgICovXG4gIHB1YmxpYyBzdG9wcGVyUmFmcmFpY2hpc3NlbWVudCgpOiBQcm9taXNlPGFueT4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKHRoaXMucHJpc21lQW5ndWxhckluaXRDb25maWcuY2xlU3RvY2thZ2VFdGF0UmFmcmFpY2hpc3NlbWVudCwgJ04nKTtcbiAgICAgIC8vIGFycsOqdCBkdSB0aW1lclxuICAgICAgdGhpcy50aW1lclN1YmplY3QubmV4dCgpO1xuICAgICAgaWYgKHRoaXMudGltZXJTdWJzY3JpcHRpb24pIHtcbiAgICAgICAgdGhpcy50aW1lclN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgfVxuICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQZXJtZXQgZGUgc3RvcHBlciBsZSByYWZyYWljaGlzc2VtZW50IGR1IGpldG9uIGV0IGRlIHNlIGRlY29ubmVjdGVyXG4gICAqIENldHRlIG3DqXRob2RlIGNvbnRpZW50IGxlcyBhcHBlbHMgw6BcbiAgICogIFJlZnJlc2hTZXJ2aWNlLnN0b3BwZXJSYWZyYWljaGlzc2VtZW50KCkgZXQgTG9naW5TZXJ2aWNlLmRlY29ubmVjdGVyKClcbiAgICogQHJldHVybnMgUHJvbWlzZTxhbnk+IHJlbnZvaSByZXNvbHZlKHRydWUpIGxvcnNxdWUgbGVzIG9ww6lyYXRpb25zIHNvbnQgdGVybWluw6llc1xuICAgKi9cbiAgcHVibGljIHN0b3BwZXJSYWZyYWljaGlzc2VtZW50RXREZWNvbm5lY3RlcigpOiBQcm9taXNlPGFueT4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLnN0b3BwZXJSYWZyYWljaGlzc2VtZW50KCkudGhlbigoKSA9PiB7XG4gICAgICAgIHRoaXMubG9naW5TZXJ2aWNlLmRlY29ubmVjdGVyKCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxufVxuIl19